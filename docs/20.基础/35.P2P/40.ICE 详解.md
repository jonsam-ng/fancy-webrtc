---
title: ICE 详解
date: 2022-07-08 17:37:36
permalink: /basic/p2p/ice/
categories:
  - 基础
  - P2P
tags:
  - 
---

<Badges :content="[{type: 'tip', text: '了解'}]" />

<TimeToRead />

## 简介

### ICE简介

ICE的全称`Interactive Connectivity Establishment`（互动式连接建立），由IETF的MMUSIC工作组开发出来的，它所提供的是一种框架，使各种NAT穿透技术可以实现统一。

ICE跟STUN和TURN不一样，**ICE不是一种协议，而是一个框架（Framework），它整合了STUN和TURN**。

### 框架图

如下：其中所有的服务Relay Server与STUN Server都可以部署到同一服务器上。

![111](https://img2020.cnblogs.com/blog/1309518/202105/1309518-20210523095701879-1261296315.png)

- 双方通信的Peer 有两台机子A和B ，他们都是在NAT之后，并且这两个终端都会在NAT后面形成一个映射后的公网的IP地址。
- 有两个NAT，在NAT外面有两个 STUN  服务，这里的STUN服务主要用于Peer终端进行NAT穿越使用的（去判断NAT类型和获取终端在公网中的IP）。STUN 服务可以有两个，也可以是一个或多个。
- Relay server，即 TURN Server，具有中继的功能，大多数情况下也具有STUN Server的功能。

### 通讯流程

那我们就来看看这ICE是如何进行工作并且使这个两个终端最终进行媒体流的通讯的？（左侧peer---通信-->右侧peer），两侧终端都是有网卡（IP），可以进行通讯。让这个终端去得到所有能够连接到这个终端B的通路。那这个终端都有哪些通路呢？

- 内网直接通信：如果两个对端是在同一个局域网内，那么这俩就直接通过这个本地的IP地址就可以进行通讯。
- 穿越NAT：终端首先访问STUN服务，通过STUN服务，能获取到NAT映射后的终端的公网地址（IP+端口）。并且终端双方可以通过服务器，获取得到对方的公网地址，就可以进行NAT穿越。那如果穿越成功了，他们也直接就能通过NAT进行通讯了。
- TURN服务进行中继：就是走中继。那这个终端通过NAT将数据转给TURN中继，中继服务，再向另外一个端去转发数据。
- ICE框架：ICE的基本的功能就是：**收集终端双方所有的通路**（因为终端可能包含多个网卡，必定包含多个通路）；**对所有通路进行检测**，看能不能通，那通了之后，那么ICE的这个工作就算结束了。

## 基础概念

### ICE Candidate

ICE Candidate 是什么？

ICE Candidate 是一个地址，包含协议、IP、端口、类型等。

获取到这些candidate之后，终端之间要交换这些candidate，那使用什么进行交换呢？通过候选者对（双方各自取一个candidate，组成候选者对），形成通路（是否可以互通，还需要进行连通性检查）是使用SDP，那么它是对于这个媒体信息以及网络信息的一个描述规范。

这个规范，最终是通过信令将这个SDP发送给对方，双方拿到各自的对方的SDP，那么就能识别出对方都有哪些通路，并且同时了解自己有哪些通路。

## 原理
