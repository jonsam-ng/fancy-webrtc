---
title: NAT 类型探测和 NAT 打洞
date: 2022-07-01 19:32:40
permalink: /basic/p2p/nat/
categories:
  - 基础
  - P2P
tags:
  - 
---

<Badges :content="[{type: 'tip', text: 'NAT 探测'}, {type: 'tip', text: 'NAT 打洞'}]" />

<TimeToRead />

## NAT：网络地址转换

网络地址转换（英语：Network Address Translation，缩写：NAT；又称网络掩蔽、IP掩蔽）在计算机网络中是一种在IP数据包通过路由器或防火墙时重写来源IP地址或目的IP地址的技术。这种技术被普遍使用在有多台主机但只通过一个公有IP地址访问互联网的私有网络中。它是一个方便且得到了广泛应用的技术。当然，NAT也让主机之间的通信变得复杂，导致了通信效率的降低。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.6ffjq8wdrd00.webp)

或者：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.131l8lv3ogw0.webp)

NAT缓解了IPV4地址不够用的问题，同时也带来了限制，那就是NAT外部的主机**无法主动**跟位于NAT内部的主机通信，**NAT内部主机想要通信，必须主动和公网的一个IP通信，路由器负责建立一个映射关系，从而实现数据的转发**， 这就是NAT的工作原理。

### 缺点

- 在一个具有NAT功能的路由器下的主机并没有创建真正的IP地址，并且不能参与一些因特网协议。
- 端对端连接是被IAB委员会（Internet Architecture Board）支持的核心因特网协议之一，因此有些人据此认为NAT是对公用因特网的一个破坏。

### 优点

NAT除了带来方便和代价之外，对全双工连接支持的缺少在一些情况下可以看作是一个有好处的特征而不是一个限制。在一定程度上，NAT依赖于本地网络上的一台机器来初始化和路由器另一边的主机的任何连接，它可以阻止外部网络上的主机的恶意活动。这样就可以阻止网络蠕虫病毒来提高本地系统的可靠性，阻挡恶意浏览来提高本地系统的私密性。很多具有NAT功能的防火墙都是使用这种功能来提供核心保护的。另外，它也为UDP的跨局域网的传输提供了方便。

参考：

- [网络地址转换 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2)

## NAT类型

基于UDP的P2P应用需要考虑NAT的类型，因为不同的NAT组合的穿透的方式并不一致，有的能通， 有的不能通。一般来讲， NAT可以分为四种类型，分别是:

- **全锥型**(Full Cone)。
- **受限锥型**(Restricted Cone)， 或者说是IP受限锥型。
- **端口受限锥型**(Port Restricted Cone), 或者说是IP + PORT受限锥型。
- **对称型**(Symmetric)。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.c3wzqfa4et4.webp)

- 完全圆锥型NAT：这是一种比较宽松的策略，只要建立了内部网络的IP地址和端口与公网IP地址和端口的映射关系，则所有Internet上的主机都可以访问该NAT之后的主机！
- 受限圆锥型NAT：当且仅当内网主机之前己经向公网主机发送过数据分组，此公网主机才能够向内网主机发送数据分组。
- 端口受限圆锥型NAT：端口受限圆锥型NAT增加了端口号的限制，当且仅当内网主机之前已经向公网主机发送了数据分组，公网主机才能和此内网主机通信。
- 对称型NAT：如果同一个内网主机，用相同的内网地址和端口向另一个地址发送数据分组，则会使用不同的映射，而且公网主机只有在接收到数据分组后，才能向与发送分组的内网主机进行通信。可见，对称性NAT是所有NAT类型中限制最为严格的。

其中1,2,3属于同一种类型，都是锥型，区别只是路由器的不同的安全策略。还有些NAT不属于这四种中的任何一种，就不在本文的讨论范围了。

## 不同NAT的穿透性

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.7bsula6phhw.webp)

对称NAT无法穿透，这个说法不正确。对称NAT与全椎NAT、对称NAT 与 ip受限椎型NAT，是可以穿透的，对称NAT与 端口受限、对称NAT与对称NAT，不可穿透。

## NAT类型判断

NAT类型的检测：查看主机所在的NAT网关（提供真正的外网IP地址，而不是伪外网IP地址）是属于哪种NAT类型，是否可以打洞成功。

下面就看一下这个整体的判断逻辑，当然在这之前要有一个限定条件，就是在云端一定要部署一个STUN服务。这个STUN服务要有两个IP地址和端口，这两个IP地址的作用稍后会在逻辑判断的过程中介绍。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.4ja4c34xj1u0.webp)

流程：

1. 首先客户端要发送一个ECHO请求给服务端（提供STUN服务），服务端收到请求之后，通过同样的IP地址和端口，给我们返回一个信息回来。
2. 那在客户端就要等这个消息回复，设置一个超时器，看每个消息是否可以按时回来，那如果我们发送的数据没有回来，则说明这个UDP是不通的，我们就不要再进行判断了（网络不通，不需要判断）。
3. 如果我们收到了服务端的响应，那么就能拿到我们这个客户端出口的公网的IP地址和端口，这个时候要判断一下公网的IP地址和本机的IP地址是否是一致的，如果是一致的，说明本机没有在NAT之后而是一个公网地址。
4. 接下来要做进一步判断，判断我们的公网地址是不是一个完全的公网地址，这时我们再发送一个信息到第一个IP地址和端口，那服务端收到这个请求之后使用第二个IP地址和端口给我们回消息，如果我们真是一个完全的公网IP地址和端口的话，那其他任何公网上的主机都可以向我发送请求和回数据，这时候我都是能收到的，那如果我能收到，那就说明就是一个公网的地址，所以我们就没有在NAT之后，就完全可以接收数据了。
5. 那如果我们收不到，那说明我是在一个防火墙之后，而且一个对称的防火墙。（可以认为与对称NAT一样）
6. 如果我收到的公网的IP与我本地的IP不一致，那就说明我们确实是在NAT之后，那既然是在NAT之后我们就要对各种类型作判断了。
7. 这时我们再发送一个请求到服务端的第一个IP地址和端口，而服务端通过第二个IP地址和端口给我们回消息，那这时候我们要判断NAT的类型是不是完全锥型，如果我们出去一个请求，在我们的NAT服务和网关上建立了一个内网地址和外网地址的映射表之后，那其他公网上的主机都可以向我这个公网IP地址（含端口）发送消息，并且我可以接收到，那么这个时候可以收到的话，我们就是一个完全锥型NAT。
8. 那么如果收不到的话，需要做进一步的判断，这时候需要（客户端主动发送数据，用来探测对称型）向服务端的第二个IP地址和端口发送数据，那么此时服务端会用同样的IP地址和端口给我们回数据，那么这时候它也会带回一个公网的IP地址来，但是如果我们的出口，就是向第二个IP地址发送了请求带回的外网IP与端口与我们第一发送的请求带回的IP地址和端口（主要是端口）如果是不一样的，那就说明是对称型NAT（对称型NAT每次出去都会在映射表上形成不同的外网IP地址和端口）。
9. 如果一样（没有修改映射表，没有新建一个映射关系，即是说明客户端的外网IP和端口不变）就说明是限制型的，限制型分为两种一种是IP限制型，一种是端口限制型，所以还需要做进一步的检测。这个时候客户端主动再向服务端第一个IP地址和端口发送一个请求，如果服务端回信息时使用的是之前回复消息所使用的同一个IP地址，但是不是同一个的端口号，那么这时候我们就可以判断是否可以接收到，如果不能接收到，说明是对端口做了限制，所以是端口限制型的NAT，如果可以收到就说明是一个IP地址限制型的NAT。
10. 经过这样一个逻辑判断之后 ，我就可以知道我们自己这台在内网的主机是什么NAT类型了。

### 过程简化

1. 公网还是 NAT：发 1 回 1，内外地址不同是 NAT。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.46x29tsnpw60.webp)

2. 是否是对称型NAT：发 1 回 1，发 2 回 2，外部地址不同是对称型。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.3r0e9unahhi0.webp)

1. 是否是完全锥型NAT：发 1 回 2，收到回应是完全锥型。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.3y9px2bw3na0.webp)

4. IP限制锥型还是端口限制锥型：发 1 换端口回 1，收到回应是IP限制锥型。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.4ibr8f9rolu0.webp)

## P2P概念

P2P即点对点通信，或称为对等联网，与传统的服务器客户端模式（如下图所示）有着明显的区别，在即时通讯方案中应用广泛（比如IM应用中的实时音视频通信、实时文件传输甚至文字聊天等）。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.4z226tbxenk0.webp)

P2P可以是一种通信模式、一种逻辑网络模型、一种技术、甚至一种理念。在P2P网络中，所有通信节点的地位都是对等的，每个节点都扮演着客户机和服务器双重角色，节点之间通过直接通信实现文件信息、处理器运算能力、存储空间等资源的共享。

P2P网络具有**分散性、可扩展性、健壮性**等特点，这使得P2P技术在信息共享、即时通讯、协同工作、分布式计算、网络存储等领域都有广阔的应用。

NAT技术和P2P技术作为经典的两项网络技术，在现在的网络上有着广泛的应用，P2P主机位于NAT网关后面的情况屡见不鲜。NAT技术虽然在一定程度上解决了IPv4地址短缺的问题，在构建防火墙、保证网络安全方面都发挥了一定的作用，却破坏了端到端的网络通信。NAT阻碍主机进行P2P通信的主要原因是**NAT不允许外网主机主动访问内网主机**，但是**P2P技术却要求通信双方都能主动发起访问**，所以要在NAT网络环境中进行有效的P2P通信，就必须采用新的解决方案。

P2P作为一项实用的技术，有很大的优化空间，并且相对于网络设备，基于P2P的应用程序在实现上更为灵活。所以为了兼容NAT，基于P2P的应用程序在开发的时候大多会根据自身特点加入一些穿越NAT的功能以解决上述问题。以下着重介绍几种常见的P2P穿越NAT方案。

## 反向链接技术

此种情况是所有P2P场景中最简单的，通信双方中只有一方位于NAT设备之后，它使用一种被称为“反向链接技术”来解决这个问题。大致的原理如下所述。

如图3所示，客户端A位于NAT之后，它通过TCP端口1234连接到服务器的TCP端口1235上，NAT设备为这个连接重新分配了TCP端口62000。客户端B也通过TCP端口1234连接到服务器端口1235上。

A和B从服务器处获知的对方的外网地址二元组{IP地址:端口号}分别为{138.76.29.7:1234}和{155.99.25.11:62000}，它们在各自的本地端口上进行侦听。

由于B 拥有外网IP地址，所以A要主动发起与B的通信，可以直接通过TCP连接到B。

但如果B尝试通过TCP主动连接到A进行P2P通信，则会失败，原因是A位于NAT设备后，虽然B发出的TCP SYN请求能够到达NAT设备的端口62000，但NAT设备会拒绝这个连接请求。

要想与Client A通信， B不是直接向A发起连接，而是通过服务器给A转发一个连接请求，反过来请求A连接到B（即进行反向链接），A在收到从服务器转发过来的请求以后，会主动向B发起一个TCP的连接请求，这样在NAT设备上就会建立起关于这个连接的相关表项，使A和B之间能够正常通信，从而建立起它们之间的TCP连接。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220704/image.6qznncvzg6g0.webp)

## 基于UDP协议的P2P打洞技术

### 原理概述

UDP打洞技术是通过中间服务器的协助在各自的NAT网关上建立相关的表项，使P2P连接的双方发送的报文能够直接穿透对方的NAT网关，从而实现P2P客户端互连。如果两台位于NAT设备后面的P2P客户端希望在自己的NAT网关上打个洞，那么他们需要一个协助者——**集中服务器**，并且还需要一种**用于打洞的Session建立机制**。

#### 什么是集中服务器？

集中服务器本质上是一台被设置在公网上的服务器，建立P2P的双方都可以直接访问到这台服务器。位于NAT网关后面的客户端A和B都可以与一台已知的集中服务器建立连接，并通过这台集中服务器了解对方的信息并中转各自的信息。

同时集中服务器的另一个重要作用在于判断某个客户端是否在NAT网关之后。具体的方法是：

一个客户端在集中服务器上登陆的时候，服务器记录下该客户端的两对地址**二元组信息**{IP地址:UDP端口}，一对是该客户端与集中服务器进行通信的自身的IP地址和端口号，另一对是集中服务器记录下的由服务器“观察”到的该客户端实际与自己通信所使用的IP地址和端口号（NAT网关的信息）。我们可以把前一对地址二元组看作是客户端的内网IP地址和端口号，把后一对地址二元组看作是客户端的内网IP地址和端口号经过NAT转换后的外网IP地址和端口号。

集中服务器可以从客户端的登陆消息中得到该客户端的内网相关信息，还可以通过登陆消息的IP头和UDP头得到该客户端的外网相关信息。

如果该客户端不是位于NAT设备后面，那么采用上述方法得到的两对地址二元组信息是完全相同的。

#### P2P的Session建立原理

假定客户端A要发起对客户端B的直接连接，具体的“打洞”过程如下：

- A最初不知道如何向客户端B发起连接，于是A向集中服务器发送消息，请求集中服务器帮助建立与客户端B的UDP连接。
- 集中服务器将含有B的外网和内网的地址二元组发给A，同时，集中服务器将包含有A的外网和内网的地址二元组信息的消息也发给B。这样一来， A与B就都知道对方外网和内网的地址二元组信息了。
- 当A收到由集中服务器发来的包含B的外网和内网的地址二元组信息后， A开始向B的地址二元组发送UDP数据包，并且A会自动锁定第一个给出响应的B的地址二元组。同理，当B收到由集中服务器发来的A的外网和内网地址二元组信息后，也会开始向A的外网和内网的地址二元组发送UDP数据包，并且自动锁定第一个得到A回应的地址二元组。由于A与B互相向对方发送UDP数据包的操作是异步的，所以A和B发送数据包的时间先后并没有时序要求。
  
下面来看下这三者之间是如何进行UDP打洞的。在这我们分三种具体情景来讨论：

- 第一种是最简单的一种情景，两个客户端都位于同一个NAT设备后面，即位于同一内网中；
- 第二种是最普遍的一种情景，两个客户端分别位于不同的NAT设备后面，分属不同的内网；
- 第三种是客户端位于两层NAT设备之后，通常最上层的NAT是由网络提供商提供的，第二层NAT是家用的NAT路由器之类的设备提供的。

### 典型P2P情景1：  两客户端位于同一NAT设备后面（即相同内网中，有两种方法）



## 声明

本文原文来自[P2P学习（一）NAT的四种类型以及类型探测 - 山上有风景](https://www.cnblogs.com/ssyfj/p/14791064.html)、[P2P学习（二）P2P中的NAT穿越(打洞)方案详解 - 山上有风景](https://www.cnblogs.com/ssyfj/p/14791980.html)，特此感谢。
