<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>STUN、TURN、ICE详解 | Fancy WebRTC</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/img/manifest.json">
    <link rel="apple-touch-icon" href="/img/android-chrome-192x192.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="WebRTC notes and learning map all you want.">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="webRTC学习,webRTC教程,webRTC入门">
    <meta name="theme-color" content="#008ACB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.fa1913f3.css" as="style"><link rel="preload" href="/assets/js/app.2b835d01.js" as="script"><link rel="preload" href="/assets/js/11.8f8d8c94.js" as="script"><link rel="preload" href="/assets/js/48.6a5f1eab.js" as="script"><link rel="preload" href="/assets/js/16.2ef6dce7.js" as="script"><link rel="preload" href="/assets/js/21.8f4f04c1.js" as="script"><link rel="preload" href="/assets/js/19.7a274e56.js" as="script"><link rel="preload" href="/assets/js/20.cc7484e4.js" as="script"><link rel="preload" href="/assets/js/15.daa60dcc.js" as="script"><link rel="preload" href="/assets/js/13.f9165900.js" as="script"><link rel="prefetch" href="/assets/js/1.2068c1db.js"><link rel="prefetch" href="/assets/js/12.a86359d8.js"><link rel="prefetch" href="/assets/js/14.5bcc0334.js"><link rel="prefetch" href="/assets/js/17.8c318acc.js"><link rel="prefetch" href="/assets/js/18.7f4f6ced.js"><link rel="prefetch" href="/assets/js/22.8e03dbef.js"><link rel="prefetch" href="/assets/js/23.ae5d7b1a.js"><link rel="prefetch" href="/assets/js/24.a07e377d.js"><link rel="prefetch" href="/assets/js/25.ae45a243.js"><link rel="prefetch" href="/assets/js/26.292813ba.js"><link rel="prefetch" href="/assets/js/27.b5422518.js"><link rel="prefetch" href="/assets/js/28.5b569d05.js"><link rel="prefetch" href="/assets/js/29.e406c2e9.js"><link rel="prefetch" href="/assets/js/30.0eba634f.js"><link rel="prefetch" href="/assets/js/31.4f67e3d8.js"><link rel="prefetch" href="/assets/js/32.9e0293ef.js"><link rel="prefetch" href="/assets/js/33.7c756595.js"><link rel="prefetch" href="/assets/js/34.335b4f17.js"><link rel="prefetch" href="/assets/js/35.01786aab.js"><link rel="prefetch" href="/assets/js/36.f2070bed.js"><link rel="prefetch" href="/assets/js/37.7c70043c.js"><link rel="prefetch" href="/assets/js/38.303adcdf.js"><link rel="prefetch" href="/assets/js/39.39b0a121.js"><link rel="prefetch" href="/assets/js/40.27cf0425.js"><link rel="prefetch" href="/assets/js/41.60cc5ac0.js"><link rel="prefetch" href="/assets/js/42.48c15345.js"><link rel="prefetch" href="/assets/js/43.836eadb6.js"><link rel="prefetch" href="/assets/js/44.f83a74c1.js"><link rel="prefetch" href="/assets/js/45.1325bd73.js"><link rel="prefetch" href="/assets/js/46.26125c7a.js"><link rel="prefetch" href="/assets/js/47.d8603164.js"><link rel="prefetch" href="/assets/js/49.2d88e192.js"><link rel="prefetch" href="/assets/js/50.e1d6d683.js"><link rel="prefetch" href="/assets/js/51.5204c164.js"><link rel="prefetch" href="/assets/js/52.890170b0.js"><link rel="prefetch" href="/assets/js/53.7d5218da.js"><link rel="prefetch" href="/assets/js/54.081d6d8a.js"><link rel="prefetch" href="/assets/js/55.9193e648.js"><link rel="prefetch" href="/assets/js/56.c283c363.js"><link rel="prefetch" href="/assets/js/57.36ca963e.js"><link rel="prefetch" href="/assets/js/58.ca50e853.js"><link rel="prefetch" href="/assets/js/59.1dfc405f.js"><link rel="prefetch" href="/assets/js/60.a6aafe70.js"><link rel="prefetch" href="/assets/js/61.35b09da6.js"><link rel="prefetch" href="/assets/js/62.d9905bc4.js"><link rel="prefetch" href="/assets/js/63.f502a4a5.js"><link rel="prefetch" href="/assets/js/64.63cb0948.js"><link rel="prefetch" href="/assets/js/65.15922937.js"><link rel="prefetch" href="/assets/js/66.0f2a61bf.js"><link rel="prefetch" href="/assets/js/67.b9bb6554.js"><link rel="prefetch" href="/assets/js/68.c993ab07.js"><link rel="prefetch" href="/assets/js/69.16e4d5cd.js"><link rel="prefetch" href="/assets/js/70.453a604a.js"><link rel="prefetch" href="/assets/js/71.57070527.js"><link rel="prefetch" href="/assets/js/72.7edf97b7.js"><link rel="prefetch" href="/assets/js/73.cb826c97.js"><link rel="prefetch" href="/assets/js/74.f40761ed.js"><link rel="prefetch" href="/assets/js/75.a8fde850.js"><link rel="prefetch" href="/assets/js/76.71255e54.js"><link rel="prefetch" href="/assets/js/77.de20ce37.js"><link rel="prefetch" href="/assets/js/78.91afa182.js"><link rel="prefetch" href="/assets/js/79.5ec162b8.js"><link rel="prefetch" href="/assets/js/80.81ba4a79.js"><link rel="prefetch" href="/assets/js/81.dd9dad97.js"><link rel="prefetch" href="/assets/js/82.5d12f510.js"><link rel="prefetch" href="/assets/js/83.14bee419.js"><link rel="prefetch" href="/assets/js/84.f01335e5.js"><link rel="prefetch" href="/assets/js/vendors~aplayer.ef69e8c8.js"><link rel="prefetch" href="/assets/js/vendors~artplayer.9f457d6b.js"><link rel="prefetch" href="/assets/js/vendors~dash.c779a1b8.js"><link rel="prefetch" href="/assets/js/vendors~dplayer.008e957a.js"><link rel="prefetch" href="/assets/js/vendors~hls.18d1f653.js"><link rel="prefetch" href="/assets/js/vendors~mpegts.02ab45df.js"><link rel="prefetch" href="/assets/js/vendors~shaka-player.f723bd71.js"><link rel="prefetch" href="/assets/js/vendors~webtorrent.271bb3b6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fa1913f3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Fancy WebRTC" class="logo"> <span class="site-name can-hide">Fancy WebRTC</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/basic/" class="nav-link router-link-active">基础</a></div><div class="nav-item"><a href="/advance/" class="nav-link">进阶</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="话题" class="dropdown-title"><a href="/topic/" class="link-title">话题</a> <span class="title" style="display:none;">话题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonsam-ng/fancy-webrtc-demos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  实例
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/source/index/" class="nav-link">源码</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ox.jonsam.site/tags/?tag=WebRTC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  书籍资料
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-webrtc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>让有意义的事变得有意思，让有意思的事变得有意义</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/basic/" class="nav-link router-link-active">基础</a></div><div class="nav-item"><a href="/advance/" class="nav-link">进阶</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="话题" class="dropdown-title"><a href="/topic/" class="link-title">话题</a> <span class="title" style="display:none;">话题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonsam-ng/fancy-webrtc-demos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  实例
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/source/index/" class="nav-link">源码</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ox.jonsam.site/tags/?tag=WebRTC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  书籍资料
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-webrtc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/basic/index/" class="sidebar-link">开始上手</a></li><li><a href="/basic/plan/" class="sidebar-link">Plan 计划</a></li><li><a href="/basic/roadmap/" class="sidebar-link">Roadmap 路线</a></li><li><a href="/basic/webrtc-1.0/" class="sidebar-link">WebRTC1.0浏览器间实时通讯</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MDN: WebRTC API</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>概要</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>P2P</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic/p2p/index/" class="sidebar-link">本章导读</a></li><li><a href="/basic/p2p/nat-basic/" class="sidebar-link">NAT基础概念详解</a></li><li><a href="/basic/p2p/nat/" class="sidebar-link">NAT 类型探测和 NAT 穿越</a></li><li><a href="/basic/p2p/nat-advance/" class="sidebar-link">NAT穿越方案进阶</a></li><li><a href="/basic/p2p/stun-turn-ice/" aria-current="page" class="active sidebar-link">STUN、TURN、ICE详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/basic/p2p/stun-turn-ice/#内容概述" class="sidebar-link">内容概述</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/stun-turn-ice/#stun详解" class="sidebar-link">STUN详解</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/stun-turn-ice/#turn详解" class="sidebar-link">TURN详解</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/stun-turn-ice/#ice简明介绍" class="sidebar-link">ICE简明介绍</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/stun-turn-ice/#本文总结" class="sidebar-link">本文总结</a></li></ul></li><li><a href="/basic/p2p/stun/" class="sidebar-link">STUN 详解</a></li><li><a href="/basic/p2p/ice/" class="sidebar-link">ICE 详解</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>协议</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-3f4da221><div class="articleInfo" data-v-3f4da221><ul class="breadcrumbs" data-v-3f4da221><li data-v-3f4da221><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-3f4da221></a></li> <li data-v-3f4da221><a href="/categories/?category=%E5%9F%BA%E7%A1%80" title="分类" data-v-3f4da221>基础</a></li><li data-v-3f4da221><a href="/categories/?category=P2P" title="分类" data-v-3f4da221>P2P</a></li></ul> <div class="info" data-v-3f4da221><div title="作者" class="author iconfont icon-touxiang" data-v-3f4da221><a href="https://github.com/jonsam-ng" target="_blank" title="作者" class="beLink" data-v-3f4da221>jonsam</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-3f4da221><a href="javascript:;" data-v-3f4da221>2022-07-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">STUN、TURN、ICE详解<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-6223a86a>了解</span></div> <!----> <h2 id="内容概述"><a href="#内容概述" class="header-anchor">#</a> 内容概述</h2> <p>在现实Internet网络环境中，大多数计算机主机都位于防火墙或NAT之后，只有少部分主机能够直接接入Internet。很多时候，我们希望网络中的两台主机能够直接进行通信，即所谓的P2P通信，而不需要其他公共服务器的中转。由于主机可能位于防火墙或NAT之后，在进行P2P通信之前，我们需要进行检测以确认它们之间能否进行P2P通信以及如何通信。这种技术通常称为NAT穿透（NAT Traversal）。最常见的NAT穿透是基于UDP的技术，如<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中定义的STUN协议。</p> <p>STUN，首先在<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中定义，作为一个完整的NAT穿透解决方案，英文全称是<code>Simple Traversal of UDP Through NATs</code>，即简单的用UDP穿透NAT。</p> <p>在新的RFC5389修订中把STUN协议定位于为穿透NAT提供工具，而不是一个完整的解决方案，英文全称是<code>Session Traversal Utilities for NAT</code>，即<strong>NAT会话穿透工具集</strong>。<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="noopener noreferrer">RFC5389<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>与<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>除了名称变化外，最大的区别是支持TCP穿透。</p> <p>TURN，首先在<a href="https://tools.ietf.org/html/rfc5766" target="_blank" rel="noopener noreferrer">RFC5766<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中定义，英文全称是<code>Traversal Using Relays around NAT:Relay Extensions to Session Traversal Utilities for NAT</code>，即<strong>使用中继穿透NAT:STUN的扩展</strong>。简单的说，<strong>TURN与STUN的共同点都是通过修改应用层中的私网地址达到NAT穿透的效果</strong>，<strong>异同点是TURN是通过两方通讯的“中间人”方式实现穿透</strong>。</p> <p>ICE跟STUN和TURN不一样，<strong>ICE不是一种协议，而是一个框架</strong>（Framework），<strong>它整合了STUN和TURN</strong>。</p> <h2 id="stun详解"><a href="#stun详解" class="header-anchor">#</a> STUN详解</h2> <p>了解STUN之前，我们需要了解NAT的种类。</p> <p>NAT对待UDP的实现方式有4种，分别如下：</p> <ul><li>Full Cone NAT：完全锥形NAT，所有从同一个内网IP和端口号发送过来的请求都会被映射成同一个外网IP和端口号，并且任何一个外网主机都可以通过这个映射的外网IP和端口号向这台内网主机发送包。</li> <li>Restricted Cone NAT：限制锥形NAT，它也是所有从同一个内网IP和端口号发送过来的请求都会被映射成同一个外网IP和端口号。与完全锥形不同的是，外网主机只能够向先前已经向它发送过数据包的内网主机发送包。</li> <li>Port Restricted Cone NAT：端口限制锥形NAT，与限制锥形NAT很相似，只不过它包括端口号。也就是说，一台IP地址X和端口P的外网主机想给内网主机发送包，必须是这台内网主机先前已经给这个IP地址X和端口P发送过数据包。</li> <li>Symmetric NAT：对称NAT，所有从同一个内网IP和端口号发送到一个特定的目的IP和端口号的请求，都会被映射到同一个IP和端口号。如果同一台主机使用相同的源地址和端口号发送包，但是发往不同的目的地，NAT将会使用不同的映射。此外，只有收到数据的外网主机才可以反过来向内网主机发送包。</li></ul> <h3 id="rfc3489-stun"><a href="#rfc3489-stun" class="header-anchor">#</a> RFC3489/STUN</h3> <p>STUN（<code>Simple Traversal of User Datagram Protocol Through Network Address Translators</code>），即<strong>简单的用UDP穿透NAT</strong>，是个<strong>轻量级的协议</strong>，是<strong>基于UDP的完整的穿透NAT的解决方案</strong>。它<strong>允许应用程序发现它们与公共互联网之间存在的NAT和防火墙及其他类型</strong>。它也可以<strong>让应用程序确定NAT分配给它们的公网IP地址和端口号</strong>。STUN是一种<code>Client/Server</code>的协议，也是一种<code>Request/Response</code>的协议，默认端口号是<code>3478</code>。</p> <p>参考：</p> <ul><li><a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">IETF官方文档RFC3489/STUN点此进入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://rfc2cn.com/rfc3489.html" target="_blank" rel="noopener noreferrer">RFC3489 中文翻译<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="报文结构"><a href="#报文结构" class="header-anchor">#</a> 报文结构</h4> <p><strong>【消息头】</strong></p> <p>所有的STUN消息都包含<strong>20个字节的消息头</strong>，包括<strong>16位的消息类型</strong>(2 个字节)，<strong>16位的消息长度</strong>（2 个字节）和<strong>128位的事务ID</strong>（16 个字节）。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_a.png" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_a.png" data-src="http://www.52im.net/data/attachment/forum/201610/12/112409m1f0zv1t36x1jfbf.png" loading="lazy" class="lazy"></p> <p><strong>消息类型许可的值如下：</strong></p> <ul><li>0x0001：捆绑请求；</li> <li>0x0101：捆绑响应；</li> <li>0x0111：捆绑错误响应；</li> <li>0x0002：共享私密请求；</li> <li>0x0102：共享私密响应；</li> <li>0x0112：共享私密错误响应。</li></ul> <p>消息长度，是消息大小的字节数，但不包括20字节的头部。事务ID，<strong>128位的标识符，用于随机请求和响应，请求与其相应的所有响应具有相同的标识符</strong>。</p> <p><strong>【消息属性】</strong></p> <p>消息头之后是0或多个属性，每个属性进行TLV编码，包括16位的属性类型、16位的属性长度和变长属性值。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_b.png" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_b.png" data-src="http://www.52im.net/data/attachment/forum/201610/12/112409kqyke5fxgkccfwqv.png" loading="lazy" class="lazy"></p> <p><strong>属性类型定义如下：</strong></p> <ul><li><code>MAPPED-ADDRESS</code>：MAPPED-ADDRESS属性表示<strong>映射过的IP地址和端口</strong>。它包括8位的地址族，16位的端口号及长度固定的IP地址。</li> <li><code>RESPONSE-ADDRESS</code>：RESPONSE-ADDRESS属性表示<strong>响应的目的地址</strong>。</li> <li><code>CHANGE-REQUEST</code>：客户使用32位的CHANGE-REQUEST属性来<strong>请求服务器使用不同的地址或端口号来发送响应</strong>。</li> <li><code>SOURCE-ADDRESS</code>：SOURCE-ADDRESS属性出现在捆绑响应中，它表示服务器发送<strong>响应的源IP地址和端口</strong>。</li> <li><code>CHANGED-ADDRESS</code>：如果捆绑请求的CHANGE-REQUEST属性中的“改变IP”和“改变端口”标志设置了，则CHANGED-ADDRESS属性表示响应发出的IP地址和端口号。</li> <li><code>USERNAME</code>：USERNAME属性用于<strong>消息的完整性检查</strong>，用于消息完整性检查中标识共享私密。USERNAME通常出现在共享私密响应中，与PASSWORD一起。当使用消息完整性检查时，可有选择地出现在捆绑请求中。</li> <li><code>PASSWORD</code>：PASSWORD属性用在共享私密响应中，与USERNAME一起。PASSWORD的值是变长的，用作共享私密，它的长度必须是4字节的倍数，以保证属性与边界对齐。</li> <li><code>MESSAGE-INTEGRITY</code>：MESSAGE-INTEGRITY属性<strong>包含STUN消息的HMAC-SHA1</strong>，它可以出现在捆绑请求或捆绑响应中；MESSAGE-INTEGRITY属性<strong>必须是任何STUN消息的最后一个属性</strong>。它的内容决定了HMAC输入的Key值。</li> <li><code>ERROR-CODE</code>：ERROR-CODE属性出现在捆绑错误响应或共享私密错误响应中。它的响应号数值范围从100到699。</li> <li><code>UNKNOWN-ATTRIBUTES</code>：UNKNOWN-ATTRIBUTES属性只存在于其ERROR-CODE属性中的响应号为420的捆绑错误响应或共享私密错误响应中。</li> <li><code>REFLECTED-FROM</code>：REFLECTED-FROM属性只存在于其对应的捆绑请求包含RESPONSE-ADDRESS属性的捆绑响应中。属性包含请求发出的源IP地址，它的目的是提供跟踪能力，这样STUN就不能被用作DOS攻击的反射器。</li></ul> <p>具体的ERROR-CODE（响应号），与它们缺省的原因语句一起，目前定义如下：</p> <ul><li><code>400（错误请求）</code>：请求变形了。客户在修改先前的尝试前不应该重试该请求。</li> <li><code>401（未授权）</code>：捆绑请求没有包含MESSAGE-INTEGRITY属性。</li> <li><code>420（未知属性）</code>：服务器不认识请求中的强制属性。</li> <li><code>430（过期资格）</code>：捆绑请求没有包含MESSAGE-INTEGRITY属性，但它使用过期的共享私密。客户应该获得新的共享私密并再次重试。</li> <li><code>431（完整性检查失败）</code>：捆绑请求包含MESSAGE-INTEGRITY属性，但HMAC验证失败。这可能是潜在攻击的表现，或者客户端实现错误</li> <li><code>432（丢失用户名）</code>：捆绑请求包含MESSAGE-INTEGRITY属性，但没有USERNAME属性。完整性检查中两项都必须存在。</li> <li><code>433（使用TLS）</code>：共享私密请求已经通过TLS（Transport Layer Security，即安全传输层协议）发送，但没有在TLS上收到。</li> <li><code>500（服务器错误）</code>：服务器遇到临时错误，客户应该再次尝试。</li> <li><code>600（全局失败）</code>：服务器拒绝完成请求，客户不应该重试。</li></ul> <p>属性空间分为可选部分与强制部分，值超过0x7fff的属性是可选的，即客户或服务器即使不认识该属性也能够处理该消息；值小于或等于0x7fff的属性是强制理解的，即除非理解该属性，否则客户或服务器就不能处理该消息。</p> <h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h4> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_1.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_1.jpg" data-src="http://www.52im.net/data/attachment/forum/201903/13/105748gtlobhsxclsd9l35.jpg" loading="lazy" class="lazy"></p> <p>STUN协议的完整交互过程如上，下面我们来介绍具体实现步骤。</p> <ul><li><p>一般情况下，<strong>客户会配置STUN服务器提供者的域名</strong>，<strong>该域名被解析为IP地址和SRV过程的端口号</strong>。<strong>服务器名是“stun”，使用UDP协议发送捆绑请求，使用TCP协议发送共享私密请求</strong>。<strong>STUN协议的缺省端口号为3478</strong>。</p></li> <li><p>若要提供完整性检查，STUN在客户和服务器间使用<strong>128位的共享私密</strong>，作为<strong>在捆绑请求和捆绑响应中的密匙</strong>。</p></li> <li><p>首先，客户通过发现过程获得它将与之建立TCP连接的IP地址和端口号。客户打开该地址和端口的连接，开始TLS协商，验证服务器的标识。客户发送共享私密请求。该请求没有属性，只有头。服务器生成响应。</p></li> <li><p>客户会在该连接上生成多个请求，但在获得用户名和密码后关闭该连接。</p></li> <li><p>服务器收到共享私密请求，验证从TLS连接上到达的该请求；如果不是通过TLS收到的请求，则生成共享私密错误响应，并设置ERROR-CODE属性为响应号433；这里区分两种情况：若通过TCP收到请求，则错误响应通过收到请求的相同连接发送；若通过UDP收到请求，则错误响应发送回请求送出的源IP和端口。</p></li> <li><p>服务器检查请求中的任何属性，当其中有不理解的小于或等于0x7fff的值，则生成共享私密错误响应，设置ERROR-CODE属性为响应号420,并包括UNKNOWN-ATTRIBUTE属性，列出它不理解的小于或等于0x7fff的属性的值。该错误响应通过TLS连接发送。</p></li> <li><p>若请求正确，服务器创建共享私密响应，包含与请求中相同的事务ID，并包含USERNAME和PASSWORD属性。用户名在10分钟内有效。</p></li> <li><p>共享私密响应通过与收到请求的相同的TLS连接发送，服务器保持连接打开状态，由客户关闭它。</p></li> <li><p>接着，客户发送捆绑请求，携带的属性包括：</p> <ul><li>可选属性：RESPONSE-ADDRESS属性和CHANGE-REQUEST属性；</li> <li>强制属性：MESSAGE-INTEGRITY属性和USERNAME属性。</li></ul></li> <li><p>客户发送捆绑请求，通过客户重传来提供可靠性。客户开始用100ms的间隔重传，每次重传间隔加倍，直至1.6秒。之间间隔1.6秒的重传继续，直到收到响应或总共已经发送了9次。因此，若9500ms后，还未收到响应，客户认为传输已经失败。</p></li> <li><p>服务器检查捆绑请求的MESSAGE-INTEGRITY属性，不存在则生成捆绑错误响应，设置ERROR-CODE属性为响应号401；若存在，计算请求的HMAC Key值。</p></li> <li><p>服务器检查USERNAME属性，不存在则生成捆绑错误响应，设置ERROR-CODE属性为响应号432；若存在，但不认识该USERNAME的共享私密（例如，它超时了），生成捆绑错误响应，设置ERROR-CODE属性为响应号430。</p></li> <li><p>若服务器知道该共享私密，但所计算的 HMAC 与请求的不同，生成捆绑错误响应，设置ERROR-CODE属性为响应号431。</p></li> <li><p>假设消息完整性检查通过了，服务器检查请求中的任何属性的值，若遇到不理解的小于或等于0x7fff的值，生成捆绑错误响应，设置ERROR-CODE属性为响应号420，该响应包含UNKNOWN-ATTRIBUTE属性，并列出不理解的小于或等于0x7fff的属性。</p></li> <li><p>若请求正确，服务器生成单个捆绑响应，包含与捆绑请求相同的事务ID。服务器在捆绑响应中加入MAPPED-ADDRESS属性，该属性的IP地址和端口号为捆绑请求的源IP地址和端口号。</p></li></ul> <p><strong>捆绑响应的源地址和端口号取决于捆绑请求中CHANGE-REQUEST属性的值及捆绑请求收到的地址和端口号相关。总结如下：</strong></p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_d.png" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_d.png" data-src="http://www.52im.net/data/attachment/forum/201610/12/112735tq1uhlhhll11qiux.png" loading="lazy" class="lazy"></p> <p>服务器在捆绑响应中加入SOURCE-ADDRESS属性，包含用于发送捆绑响应的源地址和端口号；加入CHANGED-ADDRESS属性，包含源IP地址和端口号。</p> <p>如果捆绑请求中包含了USERNAME和MESSAGE-INTEGRITY属性，则服务器在捆绑响应中加入MESSAGE-INTEGRITY属性。</p> <p>如果捆绑请求包含RESPONSE-ADDRESS属性，则服务器在捆绑响应中加入REFLECTED-FROM属性：如果捆绑请求使用从共享私密请求获得的用户名进行认证，则REFLECTED-FROM属性包含共享私密请求到达的源IP地址和端口号；若请求中的用户名不是使用共享私密分配的，则REFLECTED-FROM属性包含获得该用户名的实体的源IP地址和端口号；若请求中没有用户名，且服务器愿意处理该请求，则REFLECTED-FROM属性包含请求发出的源IP地址和端口号。</p> <p>服务器不会重传响应，可靠性通过客户周期性地重发请求来保障，每个请求都会触发服务器进行响应。</p> <p>客户端判断响应的类型是捆绑错误响应还是捆绑响应。捆绑错误响应通常在请求发送的源地址和端口收到；捆绑响应通常在请求中的RESPONSE-ADDRESS属性的地址和端口收到，若没有该属性，则捆绑响应将在请求发送的源地址和端口号收到。</p> <ul><li>若是捆绑错误响应，客户检查响应中的ERROR-CODE属性的响应号：400至499之间的未知属性按属性400处理，500至599之间的未知属性按500处理，600至699之间的未知属性按600处理。任何100和399之间的响应都会使请求重传中止，但其他则忽略；若客户收到响应的属性类型大于0x7fff，则忽略该属性，若小于或等于0x7fff，则请求重传停止，并忽略整个响应；</li> <li>若是捆绑响应，客户检查响应的MESSAGE-INTEGRITY属性：如果不存在，客户在请求中加入MESSAGE-INTEGRITY属性，并放弃该响应；如果存在，客户计算响应的HMAC。如果计算出的HMAC与响应中的不同，则放弃该响应，并警告客户可能受到了攻击；若计算出的HMAC与响应中的匹配，则过程继续；</li> <li>不论收到捆绑响应还是捆绑错误响应，都将中止该请求的重传。客户在第一次响应后继续监听捆绑请求的响应10秒钟，如果这期间它收到任何消息类型不同的响应或不同的MAPPED-ADDRESS属性，它将警告用户可能受到攻击；并且，如果客户收到的捆绑响应次数超过它发送的捆绑请求数的两倍，它将警告用户可能受到攻击；若捆绑响应经过认证，上述攻击并未导致客户丢弃MAPPED-ADDRESS，则客户可以使用该MAPPED-ADDRESS和SOURCE-ADDRESS属性。</li></ul> <h4 id="stun功能举例"><a href="#stun功能举例" class="header-anchor">#</a> STUN功能举例</h4> <p>客户通过带外方式获得STUN服务器信息后，就打开对应的地址和端口的连接，并开始与STUN服务器进行TLS协商。一旦打开了连接，客户就通过TCP协议发送共享私密请求，服务器生成共享私密响应。STUN在客户和服务器间使用共享私密，用作捆绑请求和捆绑响应中的密匙。之后，客户使用UDP协议向STUN服务器发送捆绑请求，当捆绑请求消息到达服务器的时候，它可能经过了一个或者多个NAT。结果是STUN服务器收到的捆绑请求消息的源IP地址被映射成最靠近STUN服务器的NAT的IP地址，STUN服务器把这个源IP地址和端口号复制到一个捆绑响应消息中，发送回拥有这个IP地址和端口号的客户端。</p> <p>当STUN客户端收到捆绑响应消息之后，它会将自己发送捆绑请求时绑定的本地IP地址和端口号同捆绑响应消息中的IP地址和端口号进行比较，如果不匹配，就表示客户端正处于一个或者多个NAT的前面。</p> <p>在Full-Cone NAT的情况下，在捆绑响应消息中的IP地址和端口是属于公网的，公网上的任何主机都可以使用这个IP地址和端口号向这个应用程序发送数据包，应用程序只需要在刚才发送捆绑请求的IP地址和端口上监听即可。</p> <p>当然，客户可能并不在一个Full-Cone NAT的前面，实际上，它并不知道自己在一个什么类型的NAT的前面。为了确定NAT的类型，客户端使用附加的捆绑请求。具体过程是很灵活的，但一般都会像下面这样工作：客户端再发送一个捆绑请求，这次发往另一个IP地址，但是使用的是跟上一次同一个源IP地址和源端口号，如果返回的数据包里面的IP地址和端口号和第一次返回的数据包中的不同，客户端就会知道它是在一个对称NAT的前面。客户端为了确认自己是否在一个完全锥形NAT的前面，客户端可以发送一个带有标志的捆绑请求，这个标志告诉服务器使用另一个IP地址和端口发送捆绑响应。换句话说，如果客户端使X/Y的IP地址端口对向A/B的IP地址端口对发送捆绑请求，服务器就会使用源IP地址和源端口号为C/D的地址端口对向X/Y发送捆绑响应。如果客户端收到了这个响应，它就知道它是在一个Full-Cone NAT前面。</p> <p>STUN协议允许客户端请求服务器从收到捆绑请求的IP地址往回发捆绑响应，但是要使用不同的端口号。这可以用来检查客户端是否在Port Restricted Cone NAT的前面还是在Restricted Cone NAT的前面。</p> <h3 id="rfc5389-stun"><a href="#rfc5389-stun" class="header-anchor">#</a> RFC5389/STUN</h3> <p>STUN协议在RFC5389中被重新命名为<code>Session Traversal Utilities for NAT</code>，即NAT会话穿透效用。在这里，NAT会话穿透效用被定位为一个用于其他解决NAT穿透问题协议的协议。它可以用于终端设备检查由NAT分配给终端的IP地址和端口号。同时，它也被用来检查两个终端之间的连接性，好比是一种维持NAT绑定表项的保活协议。STUN可以用于多种NAT类型，并不需要它们提供特殊的行为。</p> <p>STUN本身不再是一种完整的NAT穿透解决方案，它相当于是一种NAT穿透解决方案中的工具。这是与RFC3489/STUN版本相比最重要的改变。</p> <h4 id="stun用途"><a href="#stun用途" class="header-anchor">#</a> STUN用途</h4> <p><strong>目前定义了三种STUN用途：</strong></p> <ul><li>Interactive Connectivity Establishment（ICE）[MMUSIC-ICE]，交互式连接建立</li> <li>Client-initiated connections for SIP [SIP-OUTBOUND]，用于SIP的客户端初始化连接</li> <li>NAT Behavior Discovery [BEHAVE-NAT]，NAT行为发现</li></ul> <h4 id="报文结构-2"><a href="#报文结构-2" class="header-anchor">#</a> 报文结构</h4> <p><strong>【消息头】</strong></p> <p>STUN消息头为20字节，后面紧跟0或多个属性。STUN头部包含一STUN消息类型、<code>magic cookie</code>、事务ID和消息长度。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_1.png" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_1.png" data-src="http://www.52im.net/data/attachment/forum/201610/12/114036v0l0xcxjj6l6lc94.png" loading="lazy" class="lazy"></p> <p>每个STUN消息的最高位前2位必须为0。当STUN协议为多个协议多路复用时若使用的是同一个端口，这可以用于与其他协议区分STUN数据包。消息类型确定消息的类别（如请求、成功回应、失败回应、标志）。虽然这里有四种消息类型，但可以分为2类事务：请求/响应事务、标志事务。</p> <p><strong>消息类型字段可进一步划分为下面结构：</strong></p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_2.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_2.jpg" data-src="http://www.52im.net/data/attachment/forum/201903/13/105742jnxznxp0rhrrbr03.jpg" loading="lazy" class="lazy"></p> <p><strong>消息类型定义如下：</strong></p> <ul><li>0b00，表示请求</li> <li>0b01，表示标志</li> <li>0b10，表示成功响应</li> <li>0b11，表示错误响应</li></ul> <p>魔术字域必须包含固定的值0x2112A442。在RFC3489中，该域是事务ID的一部分。<strong>配置魔术字允许服务器检测客户是否理解某些在改进的版本中增加的属性</strong>。另外，还<strong>可用于STUN多路复用时与其他协议的包进行区分</strong>。</p> <p>96位的事务ID用于唯一的识别STUN事务。对于请求/响应事务，事务ID由STUN客户端来选择；对于标志事务，由代理（代理指支持STUN的客户端或服务器）来选择并发送。它主要服务于与请求相关的响应，因此它也扮演着一个帮助阻止确定类型的攻击的角色。服务器使用事务ID来唯一的标识出所有客户端的每一个事务。事务ID本身必须是唯一的，并且随机的从0到2的96-1次方中选择。重新发送相同的请求时，也必须使用新的事务ID。成功或错误响应必须携带与相对应的请求相同的事务ID。</p> <p>消息长度字段不包括20字节的STUN头部。所有的STUN属性必须填充为4字节的倍数。消息长度字段的最后2位总是为0，这为区分STUN包与其他协议的包提供了另外一种方法。</p> <p><strong>【消息属性】</strong></p> <p>STUN头之后是0或多个属性。每个属性都采用TLV编码，16位的类型、16位的长度及可变长度的值。每个STUN属性必须是4字节边界对齐。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_2.png" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_2.png" data-src="http://www.52im.net/data/attachment/forum/201610/12/114019vcfzuicfi6vumdfz.png" loading="lazy" class="lazy"></p> <p>属性空间被划分为2个范围。属性的类型值在0x0000到0x7fff是强制理解属性，这意味着除非STUN代理能够理解这些属性，否则将不能正常处理包含该属性的消息；属性的类型值在0x8000到0xffff范围是可选理解属性，这意味着如果STUN代理不能理解它们的话这些属性可以被忽略。</p> <p>STUN属性类型集由IANA维护，具体定义详见<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="noopener noreferrer">IETF官方文档 RFC5389<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="rfc5389与rfc3489的区别"><a href="#rfc5389与rfc3489的区别" class="header-anchor">#</a> RFC5389与RFC3489的区别</h3> <p><strong>RFC5389与RFC3489的不同点如下：</strong></p> <ul><li>去掉STUN是一种完整的NAT穿透方案的概念，现在是一种用于提供NAT穿透解决方案的工具。因而，协议的名称变为NAT会话穿透效用；</li> <li>定义了STUN的用途；</li> <li>去掉了STUN关于NAT类型检测和绑定生命期发现的用法，去掉了RESPONSE-ADDRESS、CHANGED-ADDRESS、CHANGE-REQUEST、SOURCE-ADDRESS和REFLECTED-FROM属性；</li> <li>增加了一个固定的32位的魔术字字段，事务ID字段减少了32位长度；</li> <li>增加了XOR-MAPPED-ADDRESS属性，若魔术字在捆绑请求中出现时，该属性包括在捆绑响应中。否则，RFC3489中的行为是保留的（换句话说，捆绑响应中包括MAPPED-ADDRESS）；</li> <li>介绍了消息类型字段的正式结构，带有一对明确的位来标识Request、Response、Error-Response或Indication消息。因此，消息类型字段被划分为类别和方法两部分；</li> <li>明确的指出了STUN的最高2位是0b00，当用于ICE时可以简单的与RTP包区分开来；</li> <li>增加指纹属性来提供一种明确的方法来检测当STUN协议多路复用时，STUN与其他协议之间的差异；</li> <li>增加支持IPv6，IPv4客户端可以获取一个IPv6映射地址，反之亦然；</li> <li>增加一个long-term-credential-based认证机制；</li> <li>增加了SOFTWARE、REALM、NONCE和ALTERNATE-SERVER属性；</li> <li>去掉了共享密匙方法，因此PASSWORD属性也去掉了；</li> <li>去掉了使用连续10秒侦听STUN响应来识别一个攻击的做法；</li> <li>改变事务计时器来增加TCP友好性；</li> <li>去掉了STUN例子如集中分离控制和媒体面，代替的，在使用STUN协议时提供了更多的信息；</li> <li>定义了一类填充机制来改变长度属性的说明；</li> <li>REALM、SERVER、原因语句和NONCE限制在127个字符，USERNAME限制在513个字节以内；</li> <li>为TCP和TLS改变了DNS SRV规程，UDP仍然和以前保持一致。</li></ul> <p>IETF官文档，详见：<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="noopener noreferrer">RFC5389<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="新特性介绍"><a href="#新特性介绍" class="header-anchor">#</a> 新特性介绍</h3> <h4 id="指纹机制"><a href="#指纹机制" class="header-anchor">#</a> 指纹机制</h4> <p>FINGERPRINT机制是一种可选的用于其他协议多路复用STUN时发送给相同的传输地址时区分STUN数据包的机制，该机制不支持与RFC3489相兼容。</p> <p>在一些用途中，基于相同的传输地址时多个协议会多路复用STUN消息，例如RTP协议。STUN消息必须首先和应用报文分离开。目前，在STUN报头中有3种固定的字段可以用于该目的。尽管如此，在一些案例中，三种固定字段仍然不能充分的区别开。</p> <p>当扩展的指纹机制被使用时，STUN代理在发送给其他STUN代理的消息中包括FINGERPRINT属性。当其他STUN代理收到时，除基本的检查之外，还将检查是否包含FINGERPRINT属性及它是否包含正确的值，至此，它将相信这是一个STUN消息。指纹机制帮助STUN代理检查其他协议那些看起来像是STUN消息的消息。</p> <h4 id="通过dns发现服务器机制"><a href="#通过dns发现服务器机制" class="header-anchor">#</a> 通过DNS发现服务器机制</h4> <p>STUN客户端可以使用DNS来发现STUN服务器的IP地址和端口。客户端必须知道服务器的域名。</p> <p>当客户端希望找出服务器在公网上的位置就采用捆绑请求/响应事务，SRV（资源记录表）中服务器名称是“stun”。当通过TLS会话采用捆绑请求/响应事务，SRV中服务器名称为“stuns”。STUN用户可以定义额外的DNS资源记录服务名称。</p> <p>STUN请求的默认端口是3478，用于TCP和UDP。STUN在TLS上的默认端口是5349。服务器能够在TLS上运行STUN与STUN在TCP上时使用相同的端口，只有服务器软件支持决定初始消息是否是TLS或STUN消息。</p> <p>如果SRV中没有记录可查，客户端执行A或AAAA记录查找域名。结果将会是1张IP地址表，每一个都可以使用TCP或UDP采用默认端口号连接。通常要求使用TLS，客户端使用STUN在TLS上的默认端口号连接其中一个IP地址。</p> <h4 id="认证和消息完整性机制"><a href="#认证和消息完整性机制" class="header-anchor">#</a> 认证和消息完整性机制</h4> <p><strong>短期证书机制</strong>：</p> <p>短期证书机制假设在STUN事务之前，客户端和服务器已经使用了其他协议来交换了证书，以username和password形式。这个证书是有时间限制的。例如，在ICE用途中，两个终端使用带外方式交换信息来对username和password达成一致，并在媒体会话期间使用。这个证书被用来进行消息完整性检查，用于每个请求和多个响应中。与长期证书机制相比，没有挑战和响应方式，因此，这种证书的时间限制特性的优点是可以阻止重播。</p> <p><strong>长期证书机制</strong>：</p> <p>长期证书机制依赖于一个长期证书，username和password在客户端和服务器中是共用的。这个证书从它提供给用户开始将一直是有效的，直到该用户不再是该系统的用户。这本质上是一个提供给用户username和password的传统的登入方式。</p> <p>客户端初始发送一个请求，没有提供任何证书和任何完整性检测。服务器拒绝这个请求，并提供给用户一个范围（用于指导用户或代理选择username和password）和一个nonce。这个nonce提供重放保护。它是一个cookie，由服务器选择，以这样一种方式来标示有效时间或客户端身份是有效的。客户端重试这个请求，这次包括它的username和realm和服务器提供的nonce来回应。服务器确认这个nonce和检查这个message integrity。如果它们匹配，请求则通过认证。如果这个nonce不再有效，即过期了，服务器就拒绝该请求，并提供一个新的nonce。</p> <p>在随后的到同一服务器的请求，客户端重新使用这个nonce、username和realm，和先前使用的password。这样，随后的请求不会被拒绝直到这个nonce变成无效的。需要注意的是，长期证书机制不能用来保护Indications，由于Indications不能被改变，因此，使用Indications时要么使用短期证书，要么就省略认证和消息完整性。因为长期证书机制对离线字典攻击敏感，部署的时候应该使用很难猜测的密码。</p> <h4 id="备份服务器机制"><a href="#备份服务器机制" class="header-anchor">#</a> 备份服务器机制</h4> <p>服务器使用增强的重定向功能将一个客户端转向另一个服务器，通过回应一个错误响应号为300（尝试备份）的错误响应。服务器在错误响应中携带一个ALTERNATE-SERVER属性。</p> <p>客户端收到错误响应号为300的错误响应后，在该响应中查找ALTERNATE-SERVER属性。若找到一个，客户端就会将当前的事务作废，并重新尝试发送请求到该属性中列出的服务器。请求报文若已经通过认证，则必须使用与先前发送给执行重定向操作的服务器同样的证书。如果客户端在最后5分钟里已经重试发送请求时已经重定向到了一个服务器，它必须忽略重定向操作并将当前的事务作废，这是为了防止无限的重定向循环。</p> <h3 id="rfc5389与rfc3489的兼容"><a href="#rfc5389与rfc3489的兼容" class="header-anchor">#</a> RFC5389与RFC3489的兼容</h3> <p><strong>在RFC3489中：</strong></p> <ul><li>UDP是唯一支持的传输协议</li> <li>RFC5389中的魔术字字段是<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中事务ID的一部分，事务ID长128位</li> <li>没有XOR-MAPPED-ADDRESS属性，绑定方法是使用MAPPED-ADDRESS属性代替</li> <li>有3个需要强制理解的属性，分别是：RESPONSE-ADDRESS、CHANGE-REQUEST、CHANGED-ADDRESS属性，而RFC5389中不再支持这些属性。</li></ul> <h4 id="客户端处理的改变"><a href="#客户端处理的改变" class="header-anchor">#</a> 客户端处理的改变</h4> <p>客户端想要与<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的服务器互操作，应发送一个使用绑定方法的请求消息，不包含任何消息，使用UDP协议发送给服务器。如果成功，将收到服务器发回的包含MAPPED-ADDRESS属性而不是XOR-MAPPED-ADDRESS属性的成功响应。客户端试图与基于RFC3489的应用服务器互操作必须准备好接收任意一个属性。此外，客户端必须忽略任何在响应中出现的保留的强制理解的属性。<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中规定保留属性中的0x0002、0x0004、0x0005和0x000B可能出现在绑定响应中。</p> <h4 id="服务器处理的改变"><a href="#服务器处理的改变" class="header-anchor">#</a> 服务器处理的改变</h4> <p>服务器能够察觉由<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的客户端发送的携带有不正确的魔术字的捆绑请求消息。当服务器察觉到<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的客户端，它应该将捆绑请消息中魔术字域中的值拷贝到捆绑响应中的魔术字字段中，并且插入一个MAPPED-ADDRESS属性代替XOR-MAPPED-ADDRESS属性。</p> <p>客户端在极少的环境下可能包括RESPONSE-ADDRESS或CHANGE-REQUEST属性中的一个。在这些情况下，服务器把这些属性看做是一个不认识的强制理解的属性，并回应一个错误响应。<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>版本中的STUN缺少魔术字和指纹属性这两种能够高可靠性的正确标识其他协议多路复用时的STUN消息。因此，STUN执行与<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>兼容时不应该被用于多个协议。</p> <h2 id="turn详解"><a href="#turn详解" class="header-anchor">#</a> TURN详解</h2> <h3 id="rfc5766-turn"><a href="#rfc5766-turn" class="header-anchor">#</a> RFC5766/TURN</h3> <p>TURN，在<a href="https://tools.ietf.org/html/rfc5766" target="_blank" rel="noopener noreferrer">RFC5766<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中定义，英文全称<code>Traversal Using Relays around NAT（TURN）：Relay Extensions to Session Traversal Utilities for NAT（STUN）</code>，即<strong>使用中继穿透NAT</strong>：<strong>STUN的中继扩展</strong>。简单的说，TURN与STUN的共同点都是通过修改应用层中的私网地址达到NAT穿透的效果，异同点是<strong>TURN是通过两方通讯的“中间人”方式实现穿透</strong>。</p> <p>如果一个主机位于NAT的后面，在某些情况下它不能够与其他主机点对点直接连接。在这些情况下，它需要使用中间网点提供的中继连接服务。TURN协议就是用来允许主机控制中继的操作并且使用中继与对端交换数据。<strong>TURN与其他中继控制协议不同的是它能够允许一个客户端使用一个中继地址与多个对端连接</strong>。</p> <p><strong>TURN协议被设计为ICE的一部分</strong>，用于NAT穿越，虽然如此，它也可以在没有ICE的地方单独使用。</p> <h3 id="操作概述"><a href="#操作概述" class="header-anchor">#</a> 操作概述</h3> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_1.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_1.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/115151bn2gxe2p96x612x2.jpg" loading="lazy" class="lazy"></p> <p>在一个典型组网中，一个TURN客户端连接在一个私有网络中，通过一个或多个NAT来连接到公网。在公网中有一个TURN服务器。在因特网的别处有一个或多个对端是这个TURN客户端希望通讯的。这些对端也有可能是在一个或多个NAT的后面。该客户端使用服务器作为一个中继来发送数据包 到这些对端去，并且从这些对端接收数据包。</p> <p>客户端通过一个IP地址和端口的组合来与服务器建立会话。客户端使用TURN命令在服务器上创建和操作一个<code>ALLOCATION</code>。一旦这个allocation创建好了，客户端能够在数据发往哪个对端的指示下发送应用数据到这个服务器，服务器将中继这些数据到合适的对端。客户端发送的应用数据包含在TURN消息中，服务器将数据提取出来，并以UDP数据包方式发送给对端。反向上，对端以UDP数据包方式发送应用数据到这个allocation提供的中继传输地址。因为<strong>TURN消息总是包含客户端与哪些对端通讯的指示</strong>，客户端能够使用单一的allocation来与多个对端通讯。</p> <h3 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h3> <ul><li><code>TURN client</code>：遵循RFC5766的STUN客户端。</li> <li><code>TURN server</code>：遵循RFC5766的STUN服务器。</li> <li><code>Peer</code>：TURN客户端希望连接的主机。<strong>TURN服务器为TURN客户端和它的对端中继流量</strong>，但<strong>Peer并不与TURN服务器使用TURN协议进行交互</strong>，它接收从TURN服务器发送过来的数据，并向TURN服务器发送数据。</li> <li><code>Transport Address</code>：IP地址与端口号的组合。</li> <li><code>Host Transport Address</code>：客户端或对端的传输地址。</li> <li><code>Server-Reflexive Transport Address</code>：<strong>NAT公网侧的传输地址</strong>，该地址由NAT分配，相当于一个特定的主机传输地址。</li> <li><code>Relayed Transport Address</code>：<strong>TURN服务器上的传输地址</strong>，<strong>用于客户端和对端中继数据</strong>。</li> <li><code>TURN Server Transport Address</code>：TURN服务器上的传输地址，<strong>用于客户端发送STUN消息给服务器</strong>。</li> <li><code>Peer Transport Address</code>：服务器看到的对端的传输地址，当对端是在NAT后面，则是对端的服务器反射传输地址。</li> <li><code>Allocation</code>：通过Allocate请求将<strong>中继传输地址提供给客户端</strong>，除了中继状态外，还有许可和超时定时器等。</li> <li><code>5-tuple</code>：五元组，<strong>包括客户端IP地址和端口，服务器IP地址和端口和传输协议（包括UDP、TCP、TLS）的组合</strong>。</li> <li><code>Channel</code>：通道号与对端传输地址的关联，一旦一个通道号与一个对端的传输地址绑定，客户端和服务器就能够利用带宽效应更大的通道数据消息来交换数据。</li> <li><code>Permission</code>：一个对端允许使用它的IP地址和传输协议来发送数据到TURN服务器，服务器只为从对端发来的并且匹配一个已经存在的许可的流量中继到相应的客户端。</li> <li><code>Realm</code>：服务器内用于<strong>描述服务器或内容的一个字符串</strong>，这个realm告诉客户端哪些用户名和密码的组合可用于认证请求。</li> <li><code>Nonce</code>：服务器随机<strong>选择的一个字符串</strong>，包含在报文摘要中。为了<strong>防止中继攻击</strong>，服务器应该有规律的改变这个nonce。</li></ul> <p>具体协议细节，详见IETF官方文档：<a href="https://tools.ietf.org/html/rfc5766" target="_blank" rel="noopener noreferrer">RFC5766<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="协议交互过程详细举例"><a href="#协议交互过程详细举例" class="header-anchor">#</a> 协议交互过程详细举例</h3> <p>以上图为例进行讲解，每个消息中，多个属性包含在消息中并显示它们的值。为了方便阅读，以人们可读的格式来显示。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_2.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_2.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/115958r41hgy1uht78nazu.jpg" loading="lazy" class="lazy"></p> <p>客户端使用10.1.1.2:49271作为传输地址向服务器的传输地址发送Allocate请求。客户端随机选择一个96位的事务ID。该Allocate请求消息包括SOFTWARE属性来提供客户端的软件版本信息；包括LIFETIME属性，指明客户端希望该allocation具有1小时的生命期而非缺省的10分钟；包括REQUESTED-TRANSPORT属性来告诉服务器与对端之间采用UDP协议来传输；包括DONT-FRAGMENT属性因为客户端希望在随后的Send indications中使用DON’T-FRAGMENT属性。</p> <p>服务器需要任何请求必须是经过认证的，因此服务器拒绝了该最初的Allocation请求，并且回应了携带有错误响应号为401（未授权）的Allocate错误响应；该响应包括一个REALM属性，指明认证的域；还包括一个NONCE属性和一个SOFTWARE属性。</p> <p>客户端收到了错误响应号为401的Allocate错误响应，将重新尝试发送Allocate请求，此时将包括认证属性。客户端在新的请求中重新选择一个新的事务ID。客户端包括一个USERNAME属性，使用从服务器那收到的realm值来帮助它决定使用哪个值；请求还包括REALM和NONCE属性，这两个属性是从收到的错误响应中拷贝出来的。最后，客户端包括一个MESSAGE-INTEGRITY属性。</p> <p>服务器收到认证的Allocate请求后，检查每个属性是否正确；然后，产生一个allocation，并给客户端回应Allocate成功响应。服务器在该成功响应中携带一个LIFETIME属性，本例中服务器将客户端请求的1小时生命期减小为20分钟，这是因为这个特定的服务器可能不允许超过20分钟的生命期；该响应包括XOR-RELAYED-ADDRESS属性，值为该allocation的中继传输地址；该响应还包括XOR-MAPPED-ADDRESS属性，值为客户端的server-reflexive地址；该响应也包含一个SOFTWARE属性；最后，包括一个MESSAGE-INTEGRITY属性来证明该响应，确保它的完整性。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_3.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_3.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/120031zi6vsrvx24ssg42i.jpg" loading="lazy" class="lazy"></p> <p>接着，客户端为了准备向对端A发送一些应用数据而创建一个permission。这里通过一个CreatePermission请求来做到。该请求携带XOR-PEER-ADDRESS属性包含有确定的请求的IP地址，这里为对端A的地址；需要注意的是，属性中地址的端口号被设置为0在CreatePermission请求中，并且客户端使用的是对端A的server-reflexive地址而不是它的主机地址（私网地址）；客户端在该请求中携带与之前的Allocate请求中一样的username、realm和nonce值，因此该请求被服务器认可。此时在该请求中，客户端没有携带SOFTWARE属性。</p> <p>服务器收到该CreatePermission请求，产生一个相应的许可，并以CreatePermission成功响应来回应。该响应中只包含了Transaction-ID和MESSAGE-INTEGRITY属性。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_4.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_4.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/120053ks33633olaxnpi4l.jpg" loading="lazy" class="lazy"></p> <p>现在客户端使用Send indication来发送应用数据到对端A。对端的server-reflexive传输地址包含在XOR-PEER-ADDRESS属性中，应用数据包含在DATA属性中。客户端已经在应用层上执行了路径MTU发现功能，因此通过DON’T-FRAGMENT属性来告知服务器当通过UDP方式来向对端发送数据时应设置DF位。Indications不能使用长期证书机制来认证，所以该消息中没有MESSAGE-INTEGRITY属性。</p> <p>服务器收到Send indication后，提取出应用数据封装成UDP格式发给对端A；UDP报文的源传输地址为中继传输地址，并设置DF位。</p> <p>对端A回应它自己的包含有应用数据的UDP包给服务器。目的地址为服务器的中继传输地址。当服务器收到后，将生成Data indication消息给客户端，携带有XOR-PEER-ADDRESS属性。应用数据包含在DATA属性中。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_5.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_5.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/120117zf5gi0ka7fw5o57e.jpg" loading="lazy" class="lazy"></p> <p>客户端现在若要绑定一个通道到对端B，将指定一个空闲的通道号（本例中为0x4000）包含在CHANNEL-NUMBER属性中，对端B的传输地址包含在XOR-PEER-ADDRESS属性中。与以前一样，客户端再次利用上次请求中的username、realm和nonce。</p> <p>当服务器收到该请求后，服务器绑定这个对端的通道号，为对端B的IP地址安装一个permission，然后给客户端回应一个ChannelBind成功响应消息。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_6.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_6.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/120134g98040e74ziwfiwz.jpg" loading="lazy" class="lazy"></p> <p>客户端现在发送一个ChannelData消息给服务器，携带有发送给对端B的数据。这个消息不是一个STUN消息，因此没有事务ID。它之有3个字段：通道号、数据、数据长度；服务器收到后，检查通道号后发现当前已经绑定了，就以UDP方式发送数据给对端B。</p> <p>接着，对端B发送UDP数据包回应给服务器的中继传输地址。服务器收到后，回应给客户端ChannelData消息，包含UDP数据包中的数据。服务器知道是给哪个客户端发送ChannelData消息，这是因为收到的UDP数据包中的目的地址（即服务器的中继传输地址），并且知道使用的是哪个通道号，这是因为通道已经与相应的传输地址绑定了。</p> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_7.jpg" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_7.jpg" data-src="http://www.52im.net/data/attachment/forum/201610/12/120157sixfnelrqciqexgd.jpg" loading="lazy" class="lazy"></p> <p>有时候，20分钟的生命期已经到了，客户端需要刷新allocation。此时通过发送Refresh请求来进行。该请求包含最后一次使用的username、realm和nonce，还包含SOFTWARE属性。当服务器收到这个Refresh请求时，它注意到这个nonce值已经超期了，则给客户端回应一个错误响应号为438（过期Nonce）的Refresh错误响应，并提供一个新的nonce值。可护端将重试该请求，此时携带新的nonce值。若第二次尝试被接受，服务器将回应一个成功响应。需要注意的是，此时客户端在请求中没有携带LIFETIME属性，所以服务器刷新客户端的allocation时采用缺省的10分钟生命期。</p> <h2 id="ice简明介绍"><a href="#ice简明介绍" class="header-anchor">#</a> ICE简明介绍</h2> <h3 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h3> <p>ICE的全称<code>Interactive Connectivity Establishment</code>（互动式连接建立），由IETF的 MMUSIC 工作组开发出来的，它所提供的是一种框架，使各种NAT穿透技术可以实现统一。<strong>ICE跟STUN和TURN不一样，ICE不是一种协议，而是一个框架（Framework），它整合了STUN和TURN</strong>。</p> <h3 id="应用模型"><a href="#应用模型" class="header-anchor">#</a> 应用模型</h3> <p><img alt="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_a.png" title="P2P技术详解(四)：P2P技术之STUN、TURN、ICE详解_a.png" data-src="http://www.52im.net/data/attachment/forum/201610/12/120427sj60zrara770aql5.png" loading="lazy" class="lazy"></p> <p><strong>如上图所示，如果A想与B通信，那么其过程如下：</strong></p> <ul><li>A收集所有的IP地址，并找出其中可以从STUN服务器和TURN服务器收到流量的地址；</li> <li>A向STUN服务器发送一份地址列表，然后按照排序的地址列表向B发送启动信息，目的是实现节点间的通信；</li> <li>B向启动信息中的每一个地址发送一条STUN请求；</li> <li>A将第一条接收到的STUN请求的回复信息发送给B；</li> <li>B接到STUN回复后，从中找出那些可在A和B之间实现通信的地址；</li> <li>利用列表中的排序列最高的地址进一步的设备间通信。</li></ul> <p>由于该技术是建立在多种NAT穿透协议的基础之上，并且提供了一个统一的框架，所以ICE具备了所有这些技术的优点，同时还避免了任何单个协议可能存在的缺陷。因此，ICE可以实现在未知网络拓扑结构中实现的设备互连，而且不需要进行对手配置。另外，由于该技术不需要为VoIP流量手动打开防火墙，所以也不会产生潜在的安全隐患。</p> <h2 id="本文总结"><a href="#本文总结" class="header-anchor">#</a> 本文总结</h2> <p>在现实Internet网络环境中，大多数计算机主机都位于防火墙或NAT之后，只有少部分主机能够直接接入Internet。很多时候，我们希望网络中的两台主机能够直接进行通信（即所谓的P2P通信），而不需要其它公共服务器的中转。由于主机可能位于防火墙或NAT之后，在进行P2P通信之前，我们需要进行检测以确认它们之间能否进行P2P通信以及如何通信。这种技术通常被称为NAT穿透（NAT Traversal）。</p> <p>RFC3489中定义的STUN，即简单地用UDP穿过NAT（STUN）是个轻量级的协议。它允许应用发现它们与公共互联网之间存在的NAT和防火墙及其他类型。它还为应用提供判断NAT给它们分配的公共网际协议（IP）地址。STUN可工作在许多现存NAT上，并且不需要它们做任何特别的行为。它允许广泛的各类的应用穿越现存的NAT设施。</p> <p>RFC5389中对STUN协议进行了修订，将其定位于为穿透NAT提供工具，即NAT会话穿透效用是一个用于其他解决NAT穿透问题协议的协议。它可以用于终端设备检查由NAT分配给终端的IP地址和端口号。同时，它也被用来检查两个终端之间的连接性，好比是一种维持NAT绑定表项的保活协议。STUN本身并不是一种完整的NAT穿透解决方案。它相当于是一种NAT穿透解决方案中的工具。这是与先前的版本相比最重要的改变。之前的RFC3489中定义的STUN是一个完整的穿透NAT解决方案。此外，最大的区别是支持TCP穿透。</p> <p>RFC5766中对STUN协议再次进行了扩展，即中继穿透NAT：STUN的扩展。TURN与STUN的共同点都是通过修改应用层中的私网地址达到NAT穿透的效用，异同点是TURN采用了两方通讯的“中间人”方式实现穿透，突破了原先STUN协议无法在两台主机不能够点对点直接连接下提供作用的限制。</p> <p>技术无止境，NAT穿透技术仍在不断更新中，这里只对STUN/TURN协议作了简单的介绍，具体细节请参考<a href="https://tools.ietf.org/html/rfc3489" target="_blank" rel="noopener noreferrer">RFC3489<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="noopener noreferrer">5389<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://tools.ietf.org/html/rfc5766" target="_blank" rel="noopener noreferrer">5766<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-webrtc/edit/master/docs/20.基础/35.P2P/30.STUN、TURN、ICE详解.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=STUN" title="标签">#STUN</a><a href="/tags/?tag=TURN" title="标签">#TURN</a><a href="/tags/?tag=ICE" title="标签">#ICE</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/11, 09:43:09</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/basic/p2p/nat-advance/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">NAT穿越方案进阶</div></a> <a href="/basic/p2p/stun/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">STUN 详解</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/basic/p2p/nat-advance/" class="prev">NAT穿越方案进阶</a></span> <span class="next"><a href="/basic/p2p/stun/">STUN 详解</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/basic/p2p/stun/"><div>
            STUN 详解
            <!----></div></a> <span class="date">07-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/source/api/index/"><div>
            本章导读
            <!----></div></a> <span class="date">07-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/source/category/"><div>
            目录结构
            <!----></div></a> <span class="date">07-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="博客" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="文档" target="_blank" class="iconfont icon-shuben"></a><a href="https://source.jonsam.site" title="源码" target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Fancy WebRTC | Template by <a href="https://jonsam-ng.github.io/fancy-note-starter/">Fancy Note Starter</a> | Made by <a href=https://www.jonsam.site target="_blank">jonsam</a> with ❤</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><!----><!----><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.2b835d01.js" defer></script><script src="/assets/js/11.8f8d8c94.js" defer></script><script src="/assets/js/48.6a5f1eab.js" defer></script><script src="/assets/js/16.2ef6dce7.js" defer></script><script src="/assets/js/21.8f4f04c1.js" defer></script><script src="/assets/js/19.7a274e56.js" defer></script><script src="/assets/js/20.cc7484e4.js" defer></script><script src="/assets/js/15.daa60dcc.js" defer></script><script src="/assets/js/13.f9165900.js" defer></script>
  </body>
</html>
