<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ICE 详解 | Fancy WebRTC</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3314748_9xij1pv3h4i.css">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/img/manifest.json">
    <link rel="apple-touch-icon" href="/img/android-chrome-192x192.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="WebRTC notes and learning map all you want.">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="webRTC学习,webRTC教程,webRTC入门">
    <meta name="theme-color" content="#008ACB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.fa1913f3.css" as="style"><link rel="preload" href="/assets/js/app.2b835d01.js" as="script"><link rel="preload" href="/assets/js/11.8f8d8c94.js" as="script"><link rel="preload" href="/assets/js/50.e1d6d683.js" as="script"><link rel="preload" href="/assets/js/16.2ef6dce7.js" as="script"><link rel="preload" href="/assets/js/21.8f4f04c1.js" as="script"><link rel="preload" href="/assets/js/19.7a274e56.js" as="script"><link rel="preload" href="/assets/js/20.cc7484e4.js" as="script"><link rel="preload" href="/assets/js/15.daa60dcc.js" as="script"><link rel="preload" href="/assets/js/13.f9165900.js" as="script"><link rel="prefetch" href="/assets/js/1.2068c1db.js"><link rel="prefetch" href="/assets/js/12.a86359d8.js"><link rel="prefetch" href="/assets/js/14.5bcc0334.js"><link rel="prefetch" href="/assets/js/17.8c318acc.js"><link rel="prefetch" href="/assets/js/18.7f4f6ced.js"><link rel="prefetch" href="/assets/js/22.8e03dbef.js"><link rel="prefetch" href="/assets/js/23.ae5d7b1a.js"><link rel="prefetch" href="/assets/js/24.a07e377d.js"><link rel="prefetch" href="/assets/js/25.ae45a243.js"><link rel="prefetch" href="/assets/js/26.292813ba.js"><link rel="prefetch" href="/assets/js/27.b5422518.js"><link rel="prefetch" href="/assets/js/28.5b569d05.js"><link rel="prefetch" href="/assets/js/29.e406c2e9.js"><link rel="prefetch" href="/assets/js/30.0eba634f.js"><link rel="prefetch" href="/assets/js/31.4f67e3d8.js"><link rel="prefetch" href="/assets/js/32.9e0293ef.js"><link rel="prefetch" href="/assets/js/33.7c756595.js"><link rel="prefetch" href="/assets/js/34.335b4f17.js"><link rel="prefetch" href="/assets/js/35.01786aab.js"><link rel="prefetch" href="/assets/js/36.f2070bed.js"><link rel="prefetch" href="/assets/js/37.7c70043c.js"><link rel="prefetch" href="/assets/js/38.303adcdf.js"><link rel="prefetch" href="/assets/js/39.39b0a121.js"><link rel="prefetch" href="/assets/js/40.27cf0425.js"><link rel="prefetch" href="/assets/js/41.60cc5ac0.js"><link rel="prefetch" href="/assets/js/42.48c15345.js"><link rel="prefetch" href="/assets/js/43.836eadb6.js"><link rel="prefetch" href="/assets/js/44.f83a74c1.js"><link rel="prefetch" href="/assets/js/45.1325bd73.js"><link rel="prefetch" href="/assets/js/46.26125c7a.js"><link rel="prefetch" href="/assets/js/47.d8603164.js"><link rel="prefetch" href="/assets/js/48.6a5f1eab.js"><link rel="prefetch" href="/assets/js/49.2d88e192.js"><link rel="prefetch" href="/assets/js/51.5204c164.js"><link rel="prefetch" href="/assets/js/52.890170b0.js"><link rel="prefetch" href="/assets/js/53.7d5218da.js"><link rel="prefetch" href="/assets/js/54.081d6d8a.js"><link rel="prefetch" href="/assets/js/55.9193e648.js"><link rel="prefetch" href="/assets/js/56.c283c363.js"><link rel="prefetch" href="/assets/js/57.36ca963e.js"><link rel="prefetch" href="/assets/js/58.ca50e853.js"><link rel="prefetch" href="/assets/js/59.1dfc405f.js"><link rel="prefetch" href="/assets/js/60.a6aafe70.js"><link rel="prefetch" href="/assets/js/61.35b09da6.js"><link rel="prefetch" href="/assets/js/62.d9905bc4.js"><link rel="prefetch" href="/assets/js/63.f502a4a5.js"><link rel="prefetch" href="/assets/js/64.63cb0948.js"><link rel="prefetch" href="/assets/js/65.15922937.js"><link rel="prefetch" href="/assets/js/66.0f2a61bf.js"><link rel="prefetch" href="/assets/js/67.b9bb6554.js"><link rel="prefetch" href="/assets/js/68.c993ab07.js"><link rel="prefetch" href="/assets/js/69.16e4d5cd.js"><link rel="prefetch" href="/assets/js/70.453a604a.js"><link rel="prefetch" href="/assets/js/71.57070527.js"><link rel="prefetch" href="/assets/js/72.7edf97b7.js"><link rel="prefetch" href="/assets/js/73.cb826c97.js"><link rel="prefetch" href="/assets/js/74.f40761ed.js"><link rel="prefetch" href="/assets/js/75.a8fde850.js"><link rel="prefetch" href="/assets/js/76.71255e54.js"><link rel="prefetch" href="/assets/js/77.de20ce37.js"><link rel="prefetch" href="/assets/js/78.91afa182.js"><link rel="prefetch" href="/assets/js/79.5ec162b8.js"><link rel="prefetch" href="/assets/js/80.81ba4a79.js"><link rel="prefetch" href="/assets/js/81.dd9dad97.js"><link rel="prefetch" href="/assets/js/82.5d12f510.js"><link rel="prefetch" href="/assets/js/83.14bee419.js"><link rel="prefetch" href="/assets/js/84.f01335e5.js"><link rel="prefetch" href="/assets/js/vendors~aplayer.ef69e8c8.js"><link rel="prefetch" href="/assets/js/vendors~artplayer.9f457d6b.js"><link rel="prefetch" href="/assets/js/vendors~dash.c779a1b8.js"><link rel="prefetch" href="/assets/js/vendors~dplayer.008e957a.js"><link rel="prefetch" href="/assets/js/vendors~hls.18d1f653.js"><link rel="prefetch" href="/assets/js/vendors~mpegts.02ab45df.js"><link rel="prefetch" href="/assets/js/vendors~shaka-player.f723bd71.js"><link rel="prefetch" href="/assets/js/vendors~webtorrent.271bb3b6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fa1913f3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Fancy WebRTC" class="logo"> <span class="site-name can-hide">Fancy WebRTC</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/basic/" class="nav-link router-link-active">基础</a></div><div class="nav-item"><a href="/advance/" class="nav-link">进阶</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="话题" class="dropdown-title"><a href="/topic/" class="link-title">话题</a> <span class="title" style="display:none;">话题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonsam-ng/fancy-webrtc-demos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  实例
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/source/index/" class="nav-link">源码</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ox.jonsam.site/tags/?tag=WebRTC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  书籍资料
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-webrtc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/oxygen-space/image.5a0lthv367k0.png"> <div class="blogger-info"><h3>Jonsam NG</h3> <span>让有意义的事变得有意思，让有意思的事变得有意义</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/basic/" class="nav-link router-link-active">基础</a></div><div class="nav-item"><a href="/advance/" class="nav-link">进阶</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="话题" class="dropdown-title"><a href="/topic/" class="link-title">话题</a> <span class="title" style="display:none;">话题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonsam-ng/fancy-webrtc-demos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  实例
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/source/index/" class="nav-link">源码</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ox.jonsam.site/tags/?tag=WebRTC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  书籍资料
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/slides/#/1" class="nav-link">幻灯片</a></li></ul></div></div><div class="nav-item"><a href="https://www.jonsam.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jonsam-ng/fancy-webrtc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/basic/index/" class="sidebar-link">开始上手</a></li><li><a href="/basic/plan/" class="sidebar-link">Plan 计划</a></li><li><a href="/basic/roadmap/" class="sidebar-link">Roadmap 路线</a></li><li><a href="/basic/webrtc-1.0/" class="sidebar-link">WebRTC1.0浏览器间实时通讯</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MDN: WebRTC API</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>概要</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>P2P</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic/p2p/index/" class="sidebar-link">本章导读</a></li><li><a href="/basic/p2p/nat-basic/" class="sidebar-link">NAT基础概念详解</a></li><li><a href="/basic/p2p/nat/" class="sidebar-link">NAT 类型探测和 NAT 穿越</a></li><li><a href="/basic/p2p/nat-advance/" class="sidebar-link">NAT穿越方案进阶</a></li><li><a href="/basic/p2p/stun-turn-ice/" class="sidebar-link">STUN、TURN、ICE详解</a></li><li><a href="/basic/p2p/stun/" class="sidebar-link">STUN 详解</a></li><li><a href="/basic/p2p/ice/" aria-current="page" class="active sidebar-link">ICE 详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/basic/p2p/ice/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/ice/#基础概念" class="sidebar-link">基础概念</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/ice/#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/ice/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level2"><a href="/basic/p2p/ice/#参考" class="sidebar-link">参考</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>协议</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-3f4da221><div class="articleInfo" data-v-3f4da221><ul class="breadcrumbs" data-v-3f4da221><li data-v-3f4da221><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-3f4da221></a></li> <li data-v-3f4da221><a href="/categories/?category=%E5%9F%BA%E7%A1%80" title="分类" data-v-3f4da221>基础</a></li><li data-v-3f4da221><a href="/categories/?category=P2P" title="分类" data-v-3f4da221>P2P</a></li></ul> <div class="info" data-v-3f4da221><div title="作者" class="author iconfont icon-touxiang" data-v-3f4da221><a href="https://github.com/jonsam-ng" target="_blank" title="作者" class="beLink" data-v-3f4da221>jonsam</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-3f4da221><a href="javascript:;" data-v-3f4da221>2022-07-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">ICE 详解<!----></h1>  <div class="theme-vdoing-content content__default"><div class="badge-group" data-v-ac1337e0><span class="group-tag" data-v-ac1337e0>标签：</span> <span class="badge tip" style="vertical-align:top;" data-v-ac1337e0 data-v-6223a86a>了解</span></div> <!----> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <h3 id="ice简介"><a href="#ice简介" class="header-anchor">#</a> ICE简介</h3> <p>ICE的全称<code>Interactive Connectivity Establishment</code>（互动式连接建立），由IETF的MMUSIC工作组开发出来的，它所提供的是一种框架，使各种NAT穿透技术可以实现统一。</p> <p>ICE跟STUN和TURN不一样，<strong>ICE不是一种协议，而是一个框架（Framework），它整合了STUN和TURN</strong>。</p> <h3 id="框架图"><a href="#框架图" class="header-anchor">#</a> 框架图</h3> <p>如下：其中所有的服务Relay Server与STUN Server都可以部署到同一服务器上。</p> <p><img alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220714/image.1tz5xvr0naio.png" loading="lazy" class="lazy"></p> <ul><li>双方通信的Peer 有两台机子A和B ，他们都是在NAT之后，并且这两个终端都会在NAT后面形成一个映射后的公网的IP地址。</li> <li>有两个NAT，在NAT外面有两个 STUN  服务，这里的STUN服务主要用于Peer终端进行NAT穿越使用的（去判断NAT类型和获取终端在公网中的IP）。STUN 服务可以有两个，也可以是一个或多个。</li> <li>Relay server，即 TURN Server，具有中继的功能，大多数情况下也具有STUN Server的功能。</li></ul> <h3 id="通讯流程"><a href="#通讯流程" class="header-anchor">#</a> 通讯流程</h3> <p>那我们就来看看这ICE是如何进行工作并且使这个两个终端最终进行媒体流的通讯的？两侧终端都是有网卡（IP），可以进行通讯。让这个终端去得到所有能够连接到这个终端B的通路。那这个终端都有哪些通路呢？</p> <ul><li>内网直接通信：如果两个对端是在同一个局域网内，那么这俩就直接通过这个本地的IP地址就可以进行通讯。</li> <li>穿越NAT：终端首先访问STUN服务，通过STUN服务，能获取到NAT映射后的终端的公网地址（IP+端口）。并且终端双方可以通过服务器，获取得到对方的公网地址，就可以进行NAT穿越。那如果穿越成功了，他们也直接就能通过NAT进行通讯了。</li> <li>TURN服务进行中继：就是走中继。那这个终端通过NAT将数据转给TURN中继，中继服务，再向另外一个端去转发数据。</li> <li>ICE框架：ICE的基本的功能就是：<strong>收集终端双方所有的通路</strong>（因为终端可能包含多个网卡，必定包含多个通路）；<strong>对所有通路进行检测</strong>，看能不能通，那通了之后，那么ICE的这个工作就算结束了。</li></ul> <h2 id="基础概念"><a href="#基础概念" class="header-anchor">#</a> 基础概念</h2> <p>ICE的全称为<code>Interactive Connectivity Establishment</code>，即交互式连接建立。初学者可能会将其与网络编程的ICE 弄混，其实那是不一样的东西。在网络编程中，如C++的ICE库，都是指Internet Communications Engine，是一种用于分布式程序设计的网络通信中间件。我们这里说的只是交互式连接建立。</p> <p>ICE 是一个用于在<code>offer/answer</code>模式下的<strong>NAT传输协议</strong>，主要用于<strong>UDP下多媒体会话的建立</strong>，其使用了STUN协议以及TURN 协议，同时也能被其他实现了<code>offer/answer</code>模型的的其他程序所使用，比如SIP(<code>Session Initiation Protocol</code>).</p> <p>使用<code>offer/answer</code>模型(RFC3264)的协议通常很难在NAT之间穿透，因为其目的一般是建立多媒体数据流,而且在报文中还携带了数据的源IP和端口信息，这在通过NAT时是有问题的。RFC3264还尝试在客户端之间建立直接的通路，因此中间就缺少了应用层的封装。这样设计是为了减少媒体数据延迟，减少丢包率以及减少程序部署的负担。然而这一切都很难通过NAT而完成。</p> <p>有很多解决方案可以使得这些协议运行于NAT环境之中，包括应用层网关(ALGs)，Classic STUN以及<code>Realm Specific IP+SDP</code> 协同工作等方法。不幸的是，这些技术适应性很差，在某些网络拓扑下工作很好，而在另一些环境下表现又很差，因此我们需要一个单一的、可自由定制的解决方案。以便能在所有环境中都能较好工作。</p> <h3 id="ice-candidate"><a href="#ice-candidate" class="header-anchor">#</a> ICE Candidate</h3> <p>ICE Candidate 是什么？</p> <p>ICE Candidate 是一个地址，包含协议、IP、端口、类型等。其中类型是主机类型（是经过NAT反射后地址还是中继地址，或者其他类型）</p> <p>获取到这些candidate之后，终端之间要交换这些candidate，那使用什么进行交换呢？通过候选者对（双方各自取一个candidate，组成候选者对）形成通路（是否可以互通，还需要进行连通性检查），使用SDP，SDP 是对于这个媒体信息以及网络信息的一个描述规范。</p> <p>这个规范，最终是通过信令将这个SDP发送给对方，双方拿到各自的对方的SDP，那么就能识别出对方都有哪些通路，并且同时了解自己有哪些通路。</p> <p>Candidate类型包含以下种类：</p> <ul><li>主机候选者：主机网卡的IP地址和端口。</li> <li>反射候选者：NAT反射之后的公网IP地址和端口（不是伪公网）。</li> <li>中继候选者：TURN服务提供的IP地址和端口。</li></ul> <h3 id="ice具体工作"><a href="#ice具体工作" class="header-anchor">#</a> ICE具体工作</h3> <p>ICE 主要有如下工作：</p> <ul><li>收集 Candidate</li> <li>CandidatePair 排序</li> <li>连通性检查</li></ul> <p>为什么要进行 CandidatePair 排序？</p> <p>形成多组候选者对之后，要根据一套算法进行排序，优先级最高的候选者对先做测试，因为有可能是先通的，这样就节省了时间。</p> <h3 id="candidate的获取"><a href="#candidate的获取" class="header-anchor">#</a> Candidate的获取</h3> <p>Candidate 关系图：</p> <p><img alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220714/image.2x3easptz260.png" loading="lazy" class="lazy"></p> <ul><li>本地即为agent实际就相当于一个终端，有本地网卡，网卡有IP，就是host的类型的<strong>主机候选者</strong>。</li> <li>经过NAT到TURN服务或者STUN服务。（一般情况下，STUN服务和TURN服务是部署在同一台机子上的，程序同时具有STUN和TURN两者的功能。）因此，通过以上服务就可以拿到主机的映射地址，就是NAT之后映射的公网地址（IP和端口），也就是<strong>反射候选者</strong>。</li> <li>通过向TURN服务发送一个allocate请求，如果成功了TURN服务会开通中继地址（IP地址和端口），作为<strong>中继候选者</strong>。</li></ul> <p>这三种类型就是通过以上方式获取，通过发送一个请求可以获取这几种的候选者。</p> <p>总结一下，收集 Candidate 包括如下三种类型：</p> <ul><li>主机候选者（Host Candidate）：获取本机所有IP和指定端口。</li> <li>反射候选者（Reflexive Candidate）：是通过向STUN/TURN服务发送请求的时候获取到的映射后的NAT转换后的公网IP和端口。</li> <li>中继候选者（Relay Candidate）：是通过向TURN服务发送一个allocate的请求，为数据的转发开通一个新的IP和端口，就是中继地址。</li></ul> <p>拿到这些候选者之后，需要通过SDP交换信息。</p> <h3 id="sdp格式"><a href="#sdp格式" class="header-anchor">#</a> SDP格式</h3> <p>ICE信息的描述格式通常采用标准的SDP,其全称为Session Description Protocol,即会话描述协议。</p> <p>SDP（Session Description Protocol）是一种信息格式的描述协议，本身不属于传输协议，可以被其他传输协议用来交换必要的信息，如SIP和RTSP等。</p> <p>一个SDP会话描述包含如下部分:</p> <ul><li>会话名称和会话目的。</li> <li>会话的激活时间。</li> <li>构成会话的媒体(media)。</li> <li>为了接收该媒体所需要的信息(如地址,端口,格式等)。</li></ul> <p>因为在中途参与会话也许会受限制,所以可能会需要一些额外的信息:</p> <ul><li>会话使用的的带宽信息</li> <li>会话拥有者的联系信息</li></ul> <p>一般来说，<strong>SDP必须包含充分的信息使得应用程序能够加入会话</strong>，并且<strong>可以提供任何非参与者使用时需要知道的资源状况</strong>，后者在当SDP同时用于多个会话声明协议时尤其有用。</p> <p>SDP是基于文本的协议，使用<code>ISO 10646</code>字符集和<code>UTF-8</code>编码。SDP字段名称和属性名称只使用<code>UTF-8</code>的一个子集<code>US-ASCII</code>，因此<strong>不能存在中文</strong>。虽然理论上文本字段和属性字段支持全集，但最好还是不要在其中使用中文。SDP会话描述包含了多行如下类型的文本:</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>&lt;type&gt;=&lt;value&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中type是大小写敏感的，其中一些行是必须要有的，有些是可选的，其中可选的元素标记为*，所有元素都必须以固定顺序给出，固定的顺序极大改善了错误检测，同时使得处理端设计更加简单。</p> <p>一个标准的SDP案例：</p> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token key attr-name">v</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token key attr-name">o</span><span class="token punctuation">=</span><span class="token value attr-value">jdoe 2890844526 2890842807 IN IP4 10.47.16.5</span>
<span class="token key attr-name">s</span><span class="token punctuation">=</span><span class="token value attr-value">SDP Seminar</span>
<span class="token key attr-name">i</span><span class="token punctuation">=</span><span class="token value attr-value">A Seminar on the session description protocol</span>
<span class="token key attr-name">u</span><span class="token punctuation">=</span><span class="token value attr-value">http://www.example.com/seminars/sdp.pdf</span>
<span class="token key attr-name">e</span><span class="token punctuation">=</span><span class="token value attr-value">j.doe@example.com (Jane Doe)</span>
<span class="token key attr-name">c</span><span class="token punctuation">=</span><span class="token value attr-value">IN IP4 224.2.17.12/127</span>
<span class="token key attr-name">t</span><span class="token punctuation">=</span><span class="token value attr-value">2873397496 2873404696</span>
<span class="token key attr-name">a</span><span class="token punctuation">=</span><span class="token value attr-value">recvonly</span>
<span class="token key attr-name">m</span><span class="token punctuation">=</span><span class="token value attr-value">audio 49170 RTP/AVP 0</span>
<span class="token key attr-name">m</span><span class="token punctuation">=</span><span class="token value attr-value">video 51372 RTP/AVP 99</span>
<span class="token key attr-name">a</span><span class="token punctuation">=</span><span class="token value attr-value">rtpmap:99 h263-1998/90000</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>v：version，版本信息，一般都是0;</li> <li>o：owner，表示此SDP归谁所有，比如案例中主机名字jdoe，有多个系列号，最后包含一个IP地址。（注意：这IP地址并不一定是最终要进行传输的IP的地址，在WEBRTC里并不是用这个IP，而是使用candidate中的IP。）</li> <li>c：connection，表示连接这个网络的IPV4。</li> <li>m：media，表示本次交互的媒体信息，如audio也就是音频，它使用的是RTP的协议，</li> <li>a：attribute，表示上条信息所使用的参数（属性），如对于这个音频它有一个参数a=rtpmap，即音频的编码方式是PCMU，采样率是8000。</li></ul> <p>最重要的是最后两行，它检测到有两种Candidate：</p> <ul><li>第一条是UDP的，IP 是 10.0.1.1端口是 8998，类型是host；</li> <li>第二种也是UDP的，IP是192.0.2.3端口是45664,类型是穿越NAT的映射地址。</li></ul> <p>这里没有中继地址，即同一局域网内可以互通，或者就是穿越NAT走P2P。</p> <p>标准的SDP格式如下：</p> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>会话描述:
     <span class="token key attr-name">v</span><span class="token punctuation">=</span>  <span class="token value attr-value">(protocol version，协议版本)</span>
     <span class="token key attr-name">o</span><span class="token punctuation">=</span>  <span class="token value attr-value">(originator and session identifier，发起者和会话标识符)</span>
     <span class="token key attr-name">s</span><span class="token punctuation">=</span>  <span class="token value attr-value">(session name，会话名称)</span>
     <span class="token key attr-name">i</span><span class="token punctuation">=</span><span class="token value attr-value">* (session information，会话信息)</span>
     <span class="token key attr-name">u</span><span class="token punctuation">=</span><span class="token value attr-value">* (URI of description，URI 描述)</span>
     <span class="token key attr-name">e</span><span class="token punctuation">=</span><span class="token value attr-value">* (email address，邮件地址)</span>
     <span class="token key attr-name">p</span><span class="token punctuation">=</span><span class="token value attr-value">* (phone number，电话号码)</span>
     <span class="token key attr-name">c</span><span class="token punctuation">=</span><span class="token value attr-value">* (connection information -- not required if included in</span>
          all media，连接信息)
     <span class="token key attr-name">b</span><span class="token punctuation">=</span><span class="token value attr-value">* (zero or more bandwidth information lines，带宽信息)</span>
     <span class="token key attr-name">One or more time descriptions (&quot;t</span><span class="token punctuation">=</span><span class="token value attr-value">&quot; and &quot;r=&quot; lines; see below)</span>
     <span class="token key attr-name">z</span><span class="token punctuation">=</span><span class="token value attr-value">* (time zone adjustments，时区调整)</span>
     <span class="token key attr-name">k</span><span class="token punctuation">=</span><span class="token value attr-value">* (encryption key，加密密钥)</span>
     <span class="token key attr-name">a</span><span class="token punctuation">=</span><span class="token value attr-value">* (zero or more session attribute lines，会话属性)</span>
     Zero or more media descriptions

时间信息描述:
     <span class="token key attr-name">t</span><span class="token punctuation">=</span>  <span class="token value attr-value">(time the session is active，会话处于活动状态的时间)</span>
     <span class="token key attr-name">r</span><span class="token punctuation">=</span><span class="token value attr-value">* (zero or more repeat times)</span>

多媒体信息描述(如果有的话):
     <span class="token key attr-name">m</span><span class="token punctuation">=</span>  <span class="token value attr-value">(media name and transport address，媒体名称和传输地址)</span>
     <span class="token key attr-name">i</span><span class="token punctuation">=</span><span class="token value attr-value">* (media title，媒体标题)</span>
     <span class="token key attr-name">c</span><span class="token punctuation">=</span><span class="token value attr-value">* (connection information -- optional if included at</span>
          session level，连接信息)
     <span class="token key attr-name">b</span><span class="token punctuation">=</span><span class="token value attr-value">* (zero or more bandwidth information lines，带宽信息)</span>
     <span class="token key attr-name">k</span><span class="token punctuation">=</span><span class="token value attr-value">* (encryption key，加密密钥)</span>
     <span class="token key attr-name">a</span><span class="token punctuation">=</span><span class="token value attr-value">* (zero or more media attribute lines，媒体属性)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>所有元素的type都为小写，并且不提供拓展。但是我们可以用a(attribute)字段来提供额外的信息。</p> <p>参考：</p> <ul><li><a href="http://www.rfc-editor.org/info/rfc4566" target="_blank" rel="noopener noreferrer">RFC4566<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <h3 id="candidate-pair"><a href="#candidate-pair" class="header-anchor">#</a> Candidate Pair</h3> <p>获取得到所有的candidate之后，就要形成候选对，通过检测连通性之后，形成通路。</p> <p>如何形成 CandidatePair？</p> <ul><li>一方收集到所有 Candidate 之后通过信令传输给对端；</li> <li>对端收到后开始收集 Candidate；</li> <li>双方都完成 Candidate 收集之后，将 Candidate 形成 CandidatePair。</li></ul> <h3 id="连通性检测"><a href="#连通性检测" class="header-anchor">#</a> 连通性检测</h3> <p>检查 CandidatePair 连通性包括如下三个步骤：</p> <ul><li>对所有 CandidatePair 进行<strong>优先级排序</strong>；</li> <li>对排序后的 CandidatePair 进行<strong>发送检查</strong>，检查是否能成功发送请求；</li> <li>对排序后的 CandidatePair 进行<strong>接受检查</strong>，检查是否能成功接收到回应。</li></ul> <p><img alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/20220714/image.6extokp6y200.png" loading="lazy" class="lazy"></p> <p>在实际过程中，为了节省时间，发送跟接收是串行的。</p> <h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <h3 id="offer-answer模型"><a href="#offer-answer模型" class="header-anchor">#</a> Offer/Answer模型</h3> <p>SDP用来描述多播主干网络的会话信息，但是并没有具体的交互操作细节，因此 RFC3264 定义了一种基于SDP的 <code>offer/answer</code> 模型。在该模型中，会话参与者的其中一方生成一个SDP报文构成offer，其中包含了一组offerer希望使用的多媒体流和编解码方法，以及offerer用来接收改数据的IP地址和端口信息。offer传输到会话的另一端(称为answerer)，由answerer生成一个answer，即用来响应对应offer的SDP报文。answer中包含不同offer对应的多媒体流，并指明该流是否可以接受。</p> <p>RFC3264只介绍了交换数据过程,而没有定义传递offer/answer报文的方法，后者在<code>RFC3261/SIP</code> 即会话初始化协议中描述。值得一提的是，<code>offer/answer</code> 模型也经常被SIP作为一种基本方法使用。<code>offer/answer</code> 模型在SDP报文的基础上进行了一些定义，工作过程不在此描述，需要了解细节的朋友可以参考RFC3261。</p> <h3 id="ice工作流程"><a href="#ice工作流程" class="header-anchor">#</a> ICE工作流程</h3> <p>一个典型的ICE工作环境如下，有两个端点L和R，都运行在各自的NAT之后(他们自己也许并不知道)，NAT的类型和性质也是未知的。
L和R通过交换SDP信息在彼此之间建立多媒体会话，通常交换通过一个SIP服务器完成:</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>                 +-----------+
                 |    SIP    |
+-------+        |    Srvr   |         +-------+
| STUN  |        |           |         | STUN  |
| Srvr  |        +-----------+         | Srvr  |
|       |        /           \         |       |
+-------+       /             \        +-------+
               /&lt;- Signaling -&gt;\
              /                 \
         +--------+          +--------+
         |  NAT   |          |  NAT   |
         +--------+          +--------+
           /                       \
          /                         \
         /                           \
     +-------+                    +-------+
     | Agent |                    | Agent |
     |   L   |                    |   R   |
     |       |                    |       |
     +-------+                    +-------+

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>ICE的基本思路是，每个终端都有一系列传输地址(包括传输协议,IP地址和端口)的候选，可以用来和其他端点进行通信。</p> <p>其中可能包括:</p> <ul><li>直接和网络接口联系的传输地址(host address)</li> <li>经过NAT转换的传输地址,即反射地址(server reflective address)</li> <li>TURN服务器分配的中继地址(relay address)</li></ul> <p><strong>虽然潜在要求任意一个L的候选地址都能用来和R的候选地址进行通信</strong>。但是实际中发现有许多组合是无法工作的。举例来说，如果L和R都在NAT之后而且不处于同一内网，他们的直接地址就无法进行通信。ICE的目的就是为了发现哪一对候选地址的组合可以工作，并且通过系统的方法对所有组合进行测试(用一种精心挑选的顺序)。</p> <p>为了执行ICE，客户端必须要识别出其所有的地址候选，ICE中定义了三种候选类型，有些是从物理地址或者逻辑网络接口继承而来，其他则是从STUN或者TURN服务器发现的。很自然，一个可用的地址为和本地网络接口直接联系的地址，通常是内网地址，
称为HOST CANDIDATE，如果客户端有多个网络接口，比如既连接了WiFi又插着网线，那么就可能有多个内网地址候选。</p> <p>其次，客户端通过STUN或者TURN来获得更多的候选传输地，即<code>SERVER REFLEXIVE CANDIDATES</code>和<code>RELAYED CANDIDATES</code>，
如果TURN服务器是标准化的，那么两种地址都可以通过TURN服务器获得。当L获得所有的自己的候选地址之后，会将其<strong>按优先级排序</strong>，然后通过signaling通道发送到R。<strong>候选地址被存储在SDP offer报文的属性部分</strong>。当R接收到offer之后，就会进行同样的获选地址收集过程，并返回给L。</p> <p>这一步骤之后，两个对等端都拥有了若干自己和对方的候选地址，并将其配对。组成<code>CANDIDATE PAIRS</code>。为了查看哪对组合可以工作，每个终端都进行一系列的检查。每个检查都是一次<code>STUN request/response</code>传输，将request从候选地址对的本地地址发送到远端地址。连接性检查的基本原则很简单:</p> <ul><li>以一定的优先级将候选地址对进行排序；</li> <li>以该优先级顺序发送checks请求；</li> <li>从其他终端接收到checks的确认信息。</li></ul> <p>两端连接性测试,结果是一个4次握手过程:</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code> L                        R
 -                        -
 STUN request -&gt;             \  L's
           &lt;- STUN response  /  check

            &lt;- STUN request  \  R's
 STUN response -&gt;            /  check

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>值的一提的是，STUN request的发送和接收地址都是接下来进多媒体传输(如RTP和RTCP)的地址和端口，所以，客户端实际上是将STUN协议与<code>RTP/RTCP</code>协议在数据包中进行复用(而不是在端口上复用)。</p> <p>由于STUN Binding request用来进行连接性测试，因此STUN Binding response中会包含终端的实际地址，如果这个地址和之前学习的所有地址都不匹配，发送方就会生成一个新的candidate，称为<code>PEER REFLEXIVE CANDIDATE</code>，和其他candidate一样,也要通过ICE的检查测试。</p> <h3 id="连接性检查-connectivity-checks"><a href="#连接性检查-connectivity-checks" class="header-anchor">#</a> 连接性检查(Connectivity Checks)</h3> <p>所有的ICE实现都要求与STUN(RFC5389)兼容，并且废弃<code>Classic STUN</code>(RFC3489)。ICE的完整实现既生成<code>checks</code>(作为<code>STUN client</code>)，也接收<code>checks</code>(作为<code>STUN server</code>)，而lite实现则只负责接收checks。这里只介绍完整实现情况下的检查过程。</p> <ol><li><p>为中继候选地址生成许可(Permissions)。</p></li> <li><p>从本地候选往远端候选发送<code>Binding Request</code>。</p></li></ol> <p>在Binding请求中通常需要包含一些特殊的属性，以在ICE进行连接性检查的时候提供必要信息。</p> <ul><li><code>PRIORITY</code> 和 <code>USE-CANDIDATE</code></li></ul> <p>终端必须在其request中包含PRIORITY属性，指明其优先级，优先级由公式计算而得。如果有需要也可以给出特别指定的候选(即USE-CANDIDATE属性)。</p> <ul><li><code>ICE-CONTROLLED</code>和<code>ICE-CONTROLLING</code></li></ul> <p>在每次会话中，每个终端都有一个身份。总共有两种身份，即受控方(controlled role)和主控方(controlling role)。主控方负责选择最终用来通讯的候选地址对，受控方被告知哪个候选地址对用来进行哪次媒体流传输，并且不生成更新过的offer来提示此次告知。发起ICE处理进程(即生成offer)的一方必须是主控方，而另一方则是受控方。如果终端是受控方，那么在request中就必须加上<code>ICE-CONTROLLED</code>属性，同样如果终端是主控方，就需要ICE-CONTROLLING属性。</p> <ul><li>生成<code>Credential</code></li></ul> <p><strong>作为连接性检查的<code>Binding Request</code>必须使用STUN的短期身份验证</strong>。验证的用户名被格式化为一系列username段的联结，包含了发送请求的所有对等端的用户名，以冒号隔开;密码就是对等端的密码。</p> <ol start="3"><li>处理Response。</li></ol> <p>当收到<code>Binding Response</code>时,终端会将其与<code>Binding Request</code>相联系，通常通过事务ID。随后将会将此事务ID与候选地址对进行绑定。</p> <ul><li>失败响应</li></ul> <p>如果STUN传输返回487(Role Conflict)错误响应，终端首先会检查其是否包含了<code>ICE-CONTROLLED</code>或<code>ICE-CONTROLLING</code>属性。如果有<code>ICE-CONTROLLED</code>，终端必须切换为<code>controlling role</code>;如果请求包含<code>ICE-CONTROLLING</code>属性，则必须切换为<code>controlled role</code>。切换好之后,终端必须使产生487错误的候选地址对进入检查队列中，并将此地址对的状态设置为<code>Waiting</code>。</p> <ul><li><p>成功响应，一次连接检查在满足下列所有情况时候就被认为成功:</p> <ul><li>STUN传输产生一个<code>Success Response</code>。</li> <li>response的源IP和端口等于<code>Binding Request</code>的目的IP和端口。</li> <li>response的目的IP和端口等于<code>Binding Request</code>的源IP和端口。</li></ul></li></ul> <p>终端收到成功响应之后，先检查其<code>mapped address</code>是否与本地记录的地址对有匹配，如果没有则生成一个新的候选地址，即<strong>对等端的反射地址</strong>。如果有匹配，则终端会构造一个可用候选地址对(valid pair)。通常很可能地址对不存在于任何检查列表中，检索检查列表中没有被服务器反射的本地地址，这些地址把它们的本地候选转换成服务器反射地址的基地址，并把冗余的地址去除掉。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文介绍了一种完整的NAT环境通信解决方案ICE，并且对其中涉及到的概念SDP和offer/answer模型也作了简要介绍。ICE是使用STUN/TURN工具性质的最主要协议之一，其中TURN一开始也被设计为ICE协议的一部分。值的一提的是，本文只是对这几种协议作了概述性的说明，而具体工作过程和详细的属性描述都未包含，因此如果需要根据协议来实现具体的应用程序，还需要对RFC的文档进行仔细阅读。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://www.cnblogs.com/pannengzhi/p/5061674.html" target="_blank" rel="noopener noreferrer">P2P通信标准协议(三)之ICE<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/jonsam-ng/fancy-webrtc/edit/master/docs/20.基础/35.P2P/40.ICE 详解.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/21, 16:40:55</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/basic/p2p/stun/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">STUN 详解</div></a> <a href="/pages/e76933/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">index</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/basic/p2p/stun/" class="prev">STUN 详解</a></span> <span class="next"><a href="/pages/e76933/">index</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/basic/p2p/stun/"><div>
            STUN 详解
            <!----></div></a> <span class="date">07-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/source/api/index/"><div>
            本章导读
            <!----></div></a> <span class="date">07-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/source/category/"><div>
            目录结构
            <!----></div></a> <span class="date">07-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jonsam.ng@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jonsam-ng" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.jonsam.site" title="博客" target="_blank" class="iconfont icon-mao"></a><a href="https://docs.jonsam.site" title="文档" target="_blank" class="iconfont icon-shuben"></a><a href="https://source.jonsam.site" title="源码" target="_blank" class="iconfont icon-code"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Fancy WebRTC | Template by <a href="https://jonsam-ng.github.io/fancy-note-starter/">Fancy Note Starter</a> | Made by <a href=https://www.jonsam.site target="_blank">jonsam</a> with ❤</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><!----><!----><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.2b835d01.js" defer></script><script src="/assets/js/11.8f8d8c94.js" defer></script><script src="/assets/js/50.e1d6d683.js" defer></script><script src="/assets/js/16.2ef6dce7.js" defer></script><script src="/assets/js/21.8f4f04c1.js" defer></script><script src="/assets/js/19.7a274e56.js" defer></script><script src="/assets/js/20.cc7484e4.js" defer></script><script src="/assets/js/15.daa60dcc.js" defer></script><script src="/assets/js/13.f9165900.js" defer></script>
  </body>
</html>
